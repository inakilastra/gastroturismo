<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Master SPA Template</title>
  <!-- Google Fonts: Inter (moderna y limpia) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS (via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Variables de colores para fácil personalización */
    :root {
      --color-primary: #3b82f6;
      /* Azul Neutro */
      --color-secondary: #60a5fa;
      /* Azul Claro */
      --color-background: #f3f4f6;
      /* Gris Muy Claro */
      --color-surface: #ffffff;
      /* Blanco para superficies/cards */
      --color-text-default: #374151;
      /* Gris oscuro para texto */
      --color-text-light: #6b7280;
      /* Gris medio para texto secundario */
      --color-accent: #ef4444;
      /* Rojo para acentos o advertencias */
    }

    body {
      font-family: "Inter", sans-serif;
      background-color: var(--color-background);
      color: var(--color-text-default);
    }

    /* Configuración de Tailwind para usar las variables CSS */
    /* Puedes expandir esto en un archivo tailwind.config.js si no usas CDN */
    .bg-primary {
      background-color: var(--color-primary);
    }

    .text-primary {
      color: var(--color-primary);
    }

    .bg-secondary {
      background-color: var(--color-secondary);
    }

    .text-secondary {
      color: var(--color-secondary);
    }

    .bg-background {
      background-color: var(--color-background);
    }

    .text-background {
      color: var(--color-background);
    }

    .bg-surface {
      background-color: var(--color-surface);
    }

    .text-surface {
      color: var(--color-surface);
    }

    .text-default {
      color: var(--color-text-default);
    }

    .text-light {
      color: var(--color-light);
    }

    .bg-accent {
      background-color: var(--color-accent);
    }

    .text-accent {
      color: var(--color-accent);
    }

    /* Estilo básico para el loader */
    #app-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      transition: opacity 0.3s ease-in-out;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--color-primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <!-- Lucide Icons (via CDN) -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen flex flex-col">
  <!-- Loader Inicial -->
  <div id="app-loader">
    <div class="spinner"></div>
  </div>
  <!-- Contenedor principal de la aplicación -->
  <div id="app-container" class="flex flex-col flex-1 hidden">
    <!-- Barra de Navegación Superior Fija -->
    <header id="main-navbar" class="fixed top-0 left-0 w-full bg-surface shadow-md p-4 z-10">
      <div class="container mx-auto flex justify-between items-center">
        <a href="/" class="text-xl font-bold text-primary" data-nav-link="landing">SPA Master</a>
        <nav class="hidden md:flex space-x-4">
          <a href="/#" class="hover:text-primary transition-colors" data-nav-link="landing">Inicio</a>
          <a href="/#filters" class="hover:text-primary transition-colors" data-nav-link="filter-wizard">Filtrar</a>
          <a href="/#results" class="hover:text-primary transition-colors" data-nav-link="results-grid">Resultados</a>
          <a href="/#results/alphabetical" class="hover:text-primary transition-colors"
            data-nav-link="results-grid-alpha">A-Z</a>
          <a href="/#results/chronological" class="hover:text-primary transition-colors"
            data-nav-link="results-grid-chrono">Cronológico</a>
        </nav>
        <!-- Botón para Sidebar en móvil/desktop -->
        <button id="menu-toggle-btn" class="md:hidden p-2 rounded-md hover:bg-gray-100">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
      </div>
    </header>
    <!-- Sidebar "Offcanvas" -->
    <aside id="sidebar-offcanvas"
      class="fixed top-0 left-0 h-full w-64 bg-surface shadow-lg z-20 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="p-4 flex justify-between items-center border-b border-gray-200">
        <h2 class="text-lg font-semibold text-primary">Menú</h2>
        <button id="sidebar-close-btn" class="md:hidden p-2 rounded-md hover:bg-gray-100">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="mt-4 p-4">
        <ul>
          <li class="mb-2">
            <a href="/#" class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"
              data-nav-link="landing"><i data-lucide="home" class="w-5 h-5 mr-2"></i>Inicio</a>
          </li>
          <li class="mb-2">
            <a href="/#filters" class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"
              data-nav-link="filter-wizard"><i data-lucide="filter" class="w-5 h-5 mr-2"></i>Filtrar</a>
          </li>
          <li class="mb-2">
            <a href="/#results" class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"
              data-nav-link="results-grid"><i data-lucide="grid" class="w-5 h-5 mr-2"></i>Resultados
              (Default)</a>
          </li>
          <li class="mb-2">
            <a href="/#results/alphabetical"
              class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"
              data-nav-link="results-grid-alpha"><i data-lucide="abc" class="w-5 h-5 mr-2"></i>Orden
              Alfabético</a>
          </li>
          <li class="mb-2">
            <a href="/#results/chronological"
              class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"
              data-nav-link="results-grid-chrono"><i data-lucide="calendar" class="w-5 h-5 mr-2"></i>Agrupación
              Cronológica</a>
          </li>
          <li class="mb-2">
            <a href="/#about" class="block p-2 rounded-md hover:bg-gray-100 transition-colors flex items-center"><i
                data-lucide="info" class="w-5 h-5 mr-2"></i>Acerca de</a>
          </li>
          <!-- Aquí se añadirán los filtros dinámicos del wizard -->
        </ul>
      </nav>
    </aside>
    <!-- Contenido Principal (con padding para la navbar) -->
    <main class="flex-1 pt-20 pb-16 md:pl-64">
      <!-- Ajustar pt y pl según navbar y sidebar -->
      <div class="container mx-auto p-4">
        <!-- Sección para la Landing Page -->
        <section id="landing-view" class="view">
          <h1 class="text-4xl font-bold text-center mb-8">
            Bienvenido a tu SPA Maestra
          </h1>
          <p class="text-center text-lg text-light mb-12">
            Explora un mundo de posibilidades con datos dinámicos.
          </p>
          <div id="landing-categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Aquí se renderizarán las cards de categoría -->
            <div class="bg-surface p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
              <h3 class="text-xl font-semibold mb-2">
                Categoría de Ejemplo 1
              </h3>
              <p class="text-light">
                Descripción corta de la categoría. Lorem ipsum dolor sit amet.
              </p>
            </div>
            <div class="bg-surface p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
              <h3 class="text-xl font-semibold mb-2">
                Categoría de Ejemplo 2
              </h3>
              <p class="text-light">
                Descripción corta de la categoría. Consequatur unde aliquid.
              </p>
            </div>
          </div>
        </section>
        <!-- Sección para el Wizard de Filtrado -->
        <section id="filter-wizard-view" class="view hidden">
          <h2 class="text-3xl font-bold mb-6">Wizard de Filtrado</h2>
          <div id="filter-levels" class="space-y-4">
            <!-- Aquí se renderizarán los selectores de Nivel 1, Nivel 2, etc. -->
            <div class="p-4 bg-surface rounded-lg shadow-sm">
              <label for="filter-level1" class="block text-light mb-2">Nivel 1:</label>
              <select id="filter-level1"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                <option value="">Selecciona Nivel 1</option>
              </select>
            </div>
          </div>
          <button id="show-results-btn"
            class="mt-6 px-6 py-3 bg-primary text-white rounded-md hover:bg-secondary transition-colors">
            Mostrar Resultados
          </button>
        </section>
        <!-- Sección para el Grid de Resultados -->
        <section id="results-grid-view" class="view hidden">
          <h2 class="text-3xl font-bold mb-6">Resultados de Búsqueda</h2>
          <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Aquí se renderizarán las tarjetas de resultados -->
            <div class="bg-surface rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
              <img data-src="https://via.placeholder.com/400x250?text=Item+Image" alt="Item"
                class="w-full h-48 object-cover lazyload" />
              <div class="p-4">
                <h3 class="text-xl font-semibold mb-2">Título del Ítem</h3>
                <p class="text-light text-sm mb-3">
                  Descripción corta del ítem. Lorem ipsum dolor sit amet
                  consectetur.
                </p>
                <div class="flex items-center">
                  <div class="flex text-yellow-400">
                    <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                    <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                    <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                    <i data-lucide="star" class="w-4 h-4"></i>
                    <i data-lucide="star" class="w-4 h-4"></i>
                  </div>
                  <span class="ml-2 text-sm text-light">(7.5/10)</span>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- Sección para la Vista de Detalle (Overlay/Modal) -->
        <section id="detail-view-overlay"
          class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-30 hidden p-4">
          <div class="bg-surface rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
            <button id="detail-close-btn"
              class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 z-40">
              <i data-lucide="x" class="w-6 h-6 text-default"></i>
            </button>
            <div id="detail-content" class="p-6">
              <!-- Cabecera con foto grande -->
              <div class="mb-6">
                <img data-src="https://via.placeholder.com/800x400?text=Detail+Header+Image" alt="Item Header"
                  class="w-full h-80 object-cover rounded-lg mb-4 cursor-pointer" id="detail-header-image" />
                <h2 class="text-4xl font-bold text-primary mb-2">
                  Título del Ítem Detallado
                </h2>
                <p class="text-xl text-light">Descripción Corta Aquí</p>
              </div>
              <!-- Bloque de Valoración -->
              <div class="flex items-center mb-6">
                <div class="relative w-48 h-8">
                  <!-- Fondo de estrellas grises -->
                  <div class="absolute inset-0 flex text-gray-300">
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" cla ss="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                  </div>
                  <!-- Superposición de estrellas con gradiente (ejemplo para 7.5/10 = 3.75 estrellas) -->
                  <div class="absolute inset-0 flex text-yellow-400 overflow-hidden" style="width: 75%">
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                    <i data-lucide="star" class="w-8 h-8 fill-current"></i>
                  </div>
                </div>
                <span class="ml-4 text-2xl font-semibold text-default">7.5/10</span>
              </div>
              <!-- Descripción Larga -->
              <div class="mb-6 prose max-w-none" id="detail-long-description">
                <h3 class="text-2xl font-semibold mb-3">
                  Acerca de este lugar
                </h3>
                <p>
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed
                  do eiusmod tempor incididunt ut labore et dolore magna
                  aliqua. Ut enim ad minim veniam, quis nostrud exercitation
                  ullamco laboris nisi ut aliquip ex ea commodo consequat.
                </p>
                <p>
                  Duis aute irure dolor in reprehenderit in voluptate velit
                  esse cillum dolore eu fugiat nulla pariatur. Excepteur sint
                  occaecat cupidatat non proident, sunt in culpa qui officia
                  deserunt mollit anim id est laborum.
                </p>
              </div>
              <!-- Galería de Imágenes -->
              <div class="mb-6">
                <h3 class="text-2xl font-semibold mb-3">Galería</h3>
                <div id="detail-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  <!-- Las imágenes de la galería se renderizarán aquí -->
                  <img data-src="https://via.placeholder.com/300x200?text=Gallery+1" alt="Gallery item 1"
                    class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" />
                  <img data-src="https://via.placeholder.com/300x200?text=Gallery+2" alt="Gallery item 2"
                    class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" />
                </div>
              </div>
              <!-- Información de Contacto (RRSS/Mapas) -->
              <div class="mb-6">
                <h3 class="text-2xl font-semibold mb-3">Contacto</h3>
                <div class="flex space-x-4">
                  <!-- Los botones dinámicos se insertarán aquí -->
                  <a href="#" target="_blank"
                    class="p-3 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center">
                    <i data-lucide="facebook" class="w-6 h-6"></i>
                  </a>
                  <a href="#" target="_blank"
                    class="p-3 rounded-full bg-blue-400 text-white hover:bg-blue-500 transition-colors flex items-center justify-center">
                    <i data-lucide="twitter" class="w-6 h-6"></i>
                  </a>
                  <a href="#" target="_blank"
                    class="p-3 rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors flex items-center justify-center">
                    <i data-lucide="map-pin" class="w-6 h-6"></i>
                  </a>
                </div>
              </div>
              <!-- Relacionados -->
              <div id="detail-related-items">
                <h3 class="text-2xl font-semibold mb-3">
                  Items Relacionados
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Aquí se renderizarán los ítems relacionados del segundo CSV -->
                  <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                    <h4 class="font-semibold">Evento Relacionado 1</h4>
                    <p class="text-sm text-light">
                      Breve descripción del evento. Fecha: DD/MM/AAAA
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- Lightbox Propietario -->
        <div id="custom-lightbox"
          class="fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50 hidden p-4">
          <button id="lightbox-close-btn" class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300">
            <i data-lucide="x" class="w-6 h-6 text-default"></i>
          </button>
          <button id="lightbox-prev-btn" class="absolute left-4 p-3 rounded-full bg-gray-200 hover:bg-gray-300">
            <i data-lucide="chevron-left" class="w-8 h-8 text-default"></i>
          </button>
          <img id="lightbox-img" src="" alt="Imagen en Lightbox" class="max-w-[90%] max-h-[90%] object-contain" />
          <button id="lightbox-next-btn" class="absolute right-4 p-3 rounded-full bg-gray-200 hover:bg-gray-300">
            <i data-lucide="chevron-right" class="w-8 h-8 text-default"></i>
          </button>
        </div>
      </div>
    </main>
    <!-- Footer -->
    <footer id="main-footer" class="bg-surface shadow-inner p-4 mt-auto">
      <div class="container mx-auto flex justify-center space-x-6 text-light">
        <a href="/#" class="hover:text-primary transition-colors flex items-center flex-col" data-nav-link="landing"><i
            data-lucide="home" class="w-5 h-5"></i><span class="text-xs mt-1">Inicio</span></a>
        <a href="/#filters" class="hover:text-primary transition-colors flex items-center flex-col"
          data-nav-link="filter-wizard"><i data-lucide="search" class="w-5 h-5"></i><span
            class="text-xs mt-1">Buscar</span></a>
        <a href="/#settings" class="hover:text-primary transition-colors flex items-center flex-col"
          data-nav-link="settings"><i data-lucide="settings" class="w-5 h-5"></i><span
            class="text-xs mt-1">Ajustes</span></a>
      </div>
    </footer>
    <!-- Botón Flotante (FAB) con Popover -->
    <div id="fab-container" class="fixed bottom-4 right-4 z-40">
      <button id="fab-btn"
        class="bg-accent text-white p-4 rounded-full shadow-lg hover:bg-red-600 transition-colors flex items-center justify-center">
        <i data-lucide="message-square" class="w-6 h-6"></i>
      </button>
      <div id="fab-popover" class="absolute bottom-full right-0 mb-2 p-3 bg-surface rounded-lg shadow-lg hidden w-64">
        <p class="text-sm text-default">
          ¡Hola! Aquí puedes encontrar información útil o acceder a un atajo.
        </p>
        <button class="mt-2 text-primary text-sm font-semibold hover:underline">
          Ver más
        </button>
      </div>
    </div>
  </div>
  <!-- Fin de app-container -->
    <script type="module">
      // ===============================================================================================
      // INICIALIZACIÓN Y REFERENCIAS DOM
      // ===============================================================================================

      // Inicializar Lucide Icons
      lucide.createIcons();

      // Referencias a elementos clave del DOM
      const appLoader = document.getElementById('app-loader');
      const appContainer = document.getElementById('app-container');
      const views = document.querySelectorAll('.view');

      // Vistas específicas
      const landingView = document.getElementById('landing-view');
      const filterWizardView = document.getElementById('filter-wizard-view');
      const resultsGridView = document.getElementById('results-grid-view');
      const detailViewOverlay = document.getElementById('detail-view-overlay');
      const customLightbox = document.getElementById('custom-lightbox');

      // Elementos de la barra lateral y navegación
      const sidebarOffcanvas = document.getElementById('sidebar-offcanvas');
      const menuToggleBtn = document.getElementById('menu-toggle-btn');
      const sidebarCloseBtn = document.getElementById('sidebar-close-btn');

      // Botón flotante (FAB) y su popover
      const fabBtn = document.getElementById('fab-btn');
      const fabPopover = document.getElementById('fab-popover');

      // ===============================================================================================
      // CONFIGURACIÓN GLOBAL
      // ===============================================================================================
      const CSV_MAIN_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G-G/pub?output=csv';
      const CSV_RELATED_DATA_URL = ''; // URL secundaria si aplica

      // ===============================================================================================
      // MOTOR DE NAVEGACIÓN Y ESTADO (CORE SPA LOGIC)
      // ===============================================================================================
      const state = {
        currentView: 'landing',
        filters: {},
        selectedItem: null,
        mainData: [],
        relatedData: [],
        currentGallery: [],
        currentGalleryIndex: 0,
        filterLevels: ['Nivel 1', 'Nivel 2', 'Nivel 3', 'Nivel 4'],
        sortOrder: 'default'
      };

      /**
       * Actualiza la vista principal de la aplicación.
       */
      function updateView(newView, itemId = null, sort = 'default', pushState = true) {
        views.forEach(view => view.classList.add('hidden'));
        detailViewOverlay.classList.add('hidden');
        customLightbox.classList.add('hidden');

        let newPath = '/';
        state.sortOrder = sort;

        switch (newView) {
          case 'landing':
            landingView.classList.remove('hidden');
            newPath = '/';
            renderLanding();
            break;
          case 'filter-wizard':
            filterWizardView.classList.remove('hidden');
            newPath = '/#filters';
            renderFilterWizard();
            break;
          case 'results-grid':
            resultsGridView.classList.remove('hidden');
            newPath = `/#results${sort !== 'default' ? `/${sort}` : ''}`;
            renderResultsGrid();
            break;
          case 'detail':
            detailViewOverlay.classList.remove('hidden');
            if (state.currentView !== 'results-grid' && state.currentView !== 'filter-wizard') {
              resultsGridView.classList.remove('hidden');
            }
            if (itemId) {
              state.selectedItem = state.mainData.find(item => (item.id === itemId || item.ID === itemId));
              if (!state.selectedItem) {
                updateView(state.currentView);
                return;
              }
              renderDetail(state.selectedItem);
              newPath = `/#detail/${itemId}`;
            }
            break;
          case 'settings':
            console.log('Navegando a Ajustes...');
            newPath = '/#settings';
            break;
          default:
            landingView.classList.remove('hidden');
            newView = 'landing';
            renderLanding();
        }

        state.currentView = newView;
        if (pushState) {
          history.pushState(state, '', newPath);
        }

        if (window.innerWidth < 768) {
          sidebarOffcanvas.classList.add('-translate-x-full');
        }
        lucide.createIcons();
      }

      window.addEventListener('popstate', (event) => {
        if (event.state) {
          Object.assign(state, event.state);
          if (state.currentView === 'detail' && state.selectedItem) {
            updateView('detail', state.selectedItem.id || state.selectedItem.ID, state.sortOrder, false);
          } else {
            updateView(state.currentView, null, state.sortOrder, false);
          }
        } else {
          handleLocationChange();
        }
      });

      function handleLocationChange() {
        const path = window.location.hash.substring(1);
        const parts = path.split('/');
        let view = 'landing';
        let itemId = null;
        let sort = 'default';

        if (parts[0] === 'filters') {
          view = 'filter-wizard';
        } else if (parts[0] === 'results') {
          view = 'results-grid';
          if (parts[1]) sort = parts[1];
        } else if (parts[0] === 'detail' && parts[1]) {
          view = 'detail';
          itemId = parts[1];
        }
        updateView(view, itemId, sort, false);
      }

      // ===============================================================================================
      // UTILIDADES: INGESTA Y PROCESAMIENTO DE DATOS CSV
      // ===============================================================================================
      async function fetchAndParseCSV(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Error al descargar el CSV');
          const text = await response.text();
          return parseCSV(text);
        } catch (e) {
          console.error("Error al cargar CSV:", e);
          return [];
        }
      }

      function parseCSV(csvText) {
        const results = [];
        const lines = csvText.split(/\r?\n/);
        if (lines.length === 0) return results;

        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (line.trim() === '') continue;
          
          const row = {};
          let currentCell = '';
          let inQuote = false;
          let colIndex = 0;

          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            if (char === '"') {
              if (j + 1 < line.length && line[j + 1] === '"') {
                currentCell += '"';
                j++;
              } else {
                inQuote = !inQuote;
              }
            } else if (char === ',' && !inQuote) {
              row[headers[colIndex]] = currentCell.trim();
              currentCell = '';
              colIndex++;
            } else {
              currentCell += char;
            }
          }
          row[headers[colIndex]] = currentCell.trim();
          results.push(row);
        }
        return results;
      }

      function processMainData(rawData) {
        return rawData.map((item, index) => {
          const processedItem = { ...item };
          processedItem.id = item.ID || item.id || `item-${index}`;
          processedItem.gallery = [];
          for (let i = 1; ; i++) {
            const photoCol = `foto${i}`;
            const textCol = `texto${i}`;
            if (item[photoCol] && item[photoCol].trim() !== '') {
              processedItem.gallery.push({
                src: item[photoCol],
                alt: item[textCol] || `Imagen ${i}`
              });
            } else break;
          }
          processedItem.rating = parseFloat(item['Rating 0-10']) || 0;
          processedItem.price = parseFloat(item['Precio/Valor']) || 0;
          
          processedItem.socialLinks = {};
          if (item['linkFacebook']) processedItem.socialLinks.facebook = item['linkFacebook'];
          if (item['linkTwitter']) processedItem.socialLinks.twitter = item['linkTwitter'];
          if (item['linkInstagram']) processedItem.socialLinks.instagram = item['linkInstagram'];
          if (item['linkWebsite']) processedItem.socialLinks.website = item['linkWebsite'];
          if (item['linkMapa']) processedItem.socialLinks.map = item['linkMapa'];

          return processedItem;
        });
      }

      function observeLazyImages() {
        if (!('IntersectionObserver' in window)) return;
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
              }
              observer.unobserve(img);
            }
          });
        }, { rootMargin: '0px 0px 100px 0px' });
        document.querySelectorAll('img[data-src]').forEach(img => observer.observe(img));
      }

      // ===============================================================================================
      // FUNCIONES DE RENDERIZADO
      // ===============================================================================================
      function renderLanding() {
        const grid = document.getElementById('landing-categories-grid');
        grid.innerHTML = '';
        const categories = [...new Set(state.mainData.map(item => item['Nivel 1']))].filter(Boolean);
        
        categories.forEach(cat => {
          const card = document.createElement('div');
          card.className = 'bg-surface p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer';
          card.innerHTML = `<h3 class="text-xl font-semibold mb-2">${cat}</h3><p class="text-light">Explora opciones en ${cat}.</p>`;
          card.onclick = (e) => {
            e.preventDefault();
            state.filters = { 'Nivel 1': cat };
            updateView('filter-wizard');
          };
          grid.appendChild(card);
        });
        lucide.createIcons();
      }

      function renderFilterWizard() {
        const container = document.getElementById('filter-levels');
        container.innerHTML = '';
        let currentData = state.mainData;

        state.filterLevels.forEach((level, idx) => {
          const prevLevel = state.filterLevels[idx - 1];
          if (idx > 0 && !state.filters[prevLevel]) return;

          const options = [...new Set(currentData.map(item => item[level]))].filter(Boolean);
          if (options.length === 0) return;

          const wrapper = document.createElement('div');
          wrapper.className = 'p-4 bg-surface rounded-lg shadow-sm mb-4';
          wrapper.innerHTML = `<label class="block text-light mb-2">${level}:</label>`;
          
          const select = document.createElement('select');
          select.className = 'w-full p-2 border border-gray-300 rounded';
          select.innerHTML = `<option value="">Selecciona ${level}</option>`;
          options.sort().forEach(opt => {
            const isSelected = state.filters[level] === opt ? 'selected' : '';
            select.innerHTML += `<option value="${opt}" ${isSelected}>${opt}</option>`;
          });

          select.onchange = (e) => {
            const val = e.target.value;
            if (val === '') delete state.filters[level];
            else state.filters[level] = val;
            state.filterLevels.slice(idx + 1).forEach(l => delete state.filters[l]);
            renderFilterWizard();
          };

          wrapper.appendChild(select);
          container.appendChild(wrapper);

          if (state.filters[level]) {
            currentData = currentData.filter(item => item[level] === state.filters[level]);
          }
        });

        const btn = document.getElementById('show-results-btn');
        btn.disabled = Object.keys(state.filters).length === 0;
      }

      function renderResultsGrid() {
        const container = document.getElementById('results-container');
        container.innerHTML = '';
        let items = state.mainData;

        Object.keys(state.filters).forEach(k => {
          if (state.filters[k]) items = items.filter(i => i[k] === state.filters[k]);
        });

        if (items.length === 0) {
          container.innerHTML = '<p class="text-center text-light col-span-full">Sin resultados.</p>';
          return;
        }

        items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'bg-surface rounded-lg shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer';
          card.innerHTML = `
            <img data-src="${item.gallery[0]?.src || ''}" class="w-full h-48 object-cover">
            <div class="p-4">
              <h3 class="text-xl font-semibold mb-2">${item['Título'] || 'Sin título'}</h3>
              <p class="text-light text-sm">${item['Descripción Corta'] || ''}</p>
            </div>
          `;
          card.onclick = () => updateView('detail', item.id);
          container.appendChild(card);
        });
        observeLazyImages();
        lucide.createIcons();
      }

      function renderDetail(item) {
        document.getElementById('detail-header-image').src = item.gallery[0]?.src || '';
        document.querySelector('#detail-content h2').textContent = item['Título'] || '';
        document.querySelector('#detail-content p.text-xl').textContent = item['Descripción Corta'] || '';
        document.getElementById('detail-long-description').innerHTML = item['Descripción Larga'] || 'Sin descripción adicional.';

        const gal = document.getElementById('detail-gallery');
        gal.innerHTML = '';
        item.gallery.forEach((img, idx) => {
          const el = document.createElement('img');
          el.src = img.src;
          el.className = 'w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-80 transition';
          el.onclick = () => {
            state.currentGallery = item.gallery;
            state.currentGalleryIndex = idx;
            showLightbox();
          };
          gal.appendChild(el);
        });
        
        lucide.createIcons();
      }

      function showLightbox() {
        if (state.currentGallery.length === 0) return;
        customLightbox.classList.remove('hidden');
        updateLightboxImage();
      }

      function updateLightboxImage() {
        const img = document.getElementById('lightbox-img');
        const cur = state.currentGallery[state.currentGalleryIndex];
        if (cur) {
          img.src = cur.src;
          img.alt = cur.alt;
        } else {
          customLightbox.classList.add('hidden');
        }
      }

      // Event Listeners Globales
      menuToggleBtn.onclick = () => sidebarOffcanvas.classList.remove('-translate-x-full');
      sidebarCloseBtn.onclick = () => sidebarOffcanvas.classList.add('-translate-x-full');
      document.getElementById('show-results-btn').onclick = () => updateView('results-grid');
      document.getElementById('detail-close-btn').onclick = () => history.back();
      
      document.getElementById('lightbox-close-btn').onclick = () => customLightbox.classList.add('hidden');
      document.getElementById('lightbox-next-btn').onclick = () => {
        state.currentGalleryIndex = (state.currentGalleryIndex + 1) % state.currentGallery.length;
        updateLightboxImage();
      };
      document.getElementById('lightbox-prev-btn').onclick = () => {
        state.currentGalleryIndex = (state.currentGalleryIndex - 1 + state.currentGallery.length) % state.currentGallery.length;
        updateLightboxImage();
      };

      document.querySelectorAll('[data-nav-link]').forEach(l => {
        l.onclick = (e) => {
          e.preventDefault();
          updateView(e.currentTarget.dataset.navLink);
        };
      });

      fabBtn.onclick = (e) => {
        e.stopPropagation();
        fabPopover.classList.toggle('hidden');
      };

      document.addEventListener('click', (e) => {
        if (!fabBtn.contains(e.target)) fabPopover.classList.add('hidden');
      });

      async function initApp() {
        try {
          const raw = await fetchAndParseCSV(CSV_MAIN_DATA_URL);
          state.mainData = processMainData(raw);
          appLoader.style.opacity = '0';
          setTimeout(() => {
            appLoader.classList.add('hidden');
            appContainer.classList.remove('hidden');
            handleLocationChange();
          }, 300);
        } catch (e) {
          console.error(e);
          appLoader.innerHTML = '<p class="text-red-500 p-4 bg-white rounded">Error al iniciar la aplicación.</p>';
        }
      }

      document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>