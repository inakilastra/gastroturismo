<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANeKI - Gastroturismo</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Descubre nuestras experiencias gastron√≥micas y tur√≠sticas. Pintxos, restaurantes, bodegas, eventos culinarios y mucho m√°s.">
    <meta name="author" content="I√±aki & Angels">
    <meta name="keywords" content="gastroturismo, pintxos, restaurantes, bodegas, turismo gastron√≥mico">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="ANeKI - Gastroturismo">
    <meta property="og:description" content="Compartimos nuestras experiencias gastron√≥micas y tur√≠sticas">
    <meta property="og:type" content="website">
    <meta property="og:image"
        content="https://drive.google.com/thumbnail?id=1_ac1UF-huYLYVO2pCSK-eFqk3k67l3zZ&sz=w1200">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        brand: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#009688',       /* Teal 500 */
                        secondary: '#4DB6AC',     /* Teal 300 */
                        surface: '#E0F2F1',       /* Teal 50 */
                        background: '#F0FDFD',
                        primaryContainer: '#A7FFEB', /* Teal A100 */
                        darkTeal: '#004D40',      /* Teal 900 */
                        /* 
                            star
                            teal-500 #009688
                            400 #26a69a
                            yellow-400 #f6e05e 
                        */
                    }
                }
            }
        }
    </script>

    <style>
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #009688;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #004D40;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #009688;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body
    class="bg-background text-slate-800 h-screen flex overflow-hidden font-sans selection:bg-primaryContainer selection:text-darkTeal">

    <div id="loading-overlay"
        class="fixed inset-0 bg-background z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <h2 id="loading-text" class="font-brand text-2xl text-darkTeal">Cargando Aneki...</h2>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden transition-opacity"
        onclick="toggleMenu()" aria-hidden="true"></div>

    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-darkTeal text-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-teal-800/50">
            <div class="font-brand text-2xl tracking-widest text-primaryContainer">ANeKI</div>
            <button onclick="toggleMenu()" class="md:hidden text-teal-200 hover:text-white">
                <i data-lucide="x"></i>
            </button>
        </div>

        <nav class="p-4 space-y-1 flex-1 overflow-y-auto" id="nav-menu" aria-label="Navegaci√≥n principal">
        </nav>

        <div class="p-6 bg-teal-950/30 text-xs text-center text-teal-400/60 font-brand">
            <p>Gastroturismo 2.0</p>
            <p>¬© I√±aki & Angels</p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative md:ml-64 w-full transition-all duration-300 bg-[#F0FDFD]">

        <div
            class="md:hidden h-[70px] bg-primary flex items-center px-4 text-white shadow-lg flex-shrink-0 z-20 justify-between">
            <div class="flex items-center">
                <button onclick="toggleMenu()" class="p-2 -ml-2 hover:bg-white/10 rounded-full transition mr-3"
                    aria-label="Abrir men√∫ de navegaci√≥n">
                    <i data-lucide="menu"></i>
                </button>
                <span class="font-brand text-xl tracking-wide">Gastroturismo</span>
            </div>
        </div>

        <div id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth p-4 md:p-8 pb-24">
        </div>
    </main>

    <script>
        // --- CONFIGURACI√ìN DE CSVs ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwnZA7s0yysf5rIflyyj6WNhe_XddN2OCZ6SBJfB06LFm7fANQeZfHTs7GtSlLVXmNoG16BhVStAkD/pub?gid=47128061&single=true&output=csv';
        const EVENTOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwnZA7s0yysf5rIflyyj6WNhe_XddN2OCZ6SBJfB06LFm7fANQeZfHTs7GtSlLVXmNoG16BhVStAkD/pub?gid=584577480&single=true&output=csv';

        // Generar COLS din√°micamente para mejor mantenibilidad
        const COLS = {
           
            idsitio: 0, sitio: 1, autonomia: 2, provincia: 3, ciudad: 4, 
            barrio: 5, orden: 6, valoracion: 7, codprecio: 8, precio: 9, 
            barloultimo: 10, precioultimo: 11, barbreve: 12, bardetalle: 13, 
            comida: 14, tipositio: 15, direccion: 16, horario: 17, 
            googleresenas: 18, maps: 19, facebook: 20, instagram: 21, 
            postinstagram: 22, web: 23
        };

        // Generar columnas de fotos din√°micamente (foto1-foto40, text1-text40)       
        for (let i = 1; i <= 40; i++) {
            COLS[`foto${i}`] = 24 + (i - 1) * 2;
            COLS[`text${i}`] = 25 + (i - 1) * 2;
        }

        const COLS_EVENTOS = { eventoCulinario: 1, eventoMes: 2, eventoCulinarioDescripcion: 3, idSitio: 4, anyo: 5, foto1: 6 };

        // Constantes para c√≥digos de precio
        const PRICE_CODES = {
            VERY_GOOD: 10,
            FAIR: 11,
            EXPENSIVE: 12
        };

        let DATA = [];

        const MENUS = [
            { id: 'landing', label: 'Inicio', icon: 'home' },
            { id: 'pintxos', label: 'Pintxos, Tapas...', icon: 'utensils-crossed', keywords: ['pintxo', 'tapa', 'bar'] },
            { id: 'restaurantes', label: 'Restaurantes', icon: 'chef-hat', keywords: ['restaurante', 'asador', 'comida'] },
            { id: 'bodegas', label: 'Bodegas', icon: 'wine', keywords: ['bodega', 'vino', 'catas'] },
            { id: 'turismo', label: 'Turismo', icon: 'compass', keywords: ['turismo', 'visita', 'museo'] },
            { id: 'eventosCulinarios', label: 'Eventos Culinarios', icon: 'calendar-heart' },
            { id: 'eventosTuristicos', label: 'Eventos Turisticos', icon: 'map' },
            { id: 'tiendas', label: 'Tiendas', icon: 'shopping-bag', keywords: ['tienda', 'comercio', 'gourmet'] },
            { id: 'curiosidades', label: 'Carteles, Se√±ales', icon: 'help-circle', keywords: ['curiosidad', 'cartel', 'se√±al'] },
        ];

        const state = {
            view: 'landing',
            filters: {},
            selectedItem: null,
            filterStep: 0,

            // M√©todo helper para resetear estado
            reset() {
                this.filters = {};
                this.selectedItem = null;
                this.filterStep = 0;
            }
        };

        // --- FUNCIONES HELPER ---

        // Escapar HTML para prevenir XSS
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper para crear iconos
        function createIcon(lucideIcon, width = 24, height = 24, classes = '') {
            return `<i data-lucide="${lucideIcon}" ${width ? `width="${width}"` : ''} ${height ? `height="${height}"` : ''} ${classes ? `class="${classes}"` : ''}></i>`;
        }

        // Helper para reinicializar iconos de Lucide
        function refreshIcons() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Debounce helper para optimizaci√≥n
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- PARSER CSV ---
        function parseCSV(csvText) {
            const rows = []; let fields = []; let currentField = ''; let inQuotes = false;
            csvText = csvText.trim();
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < csvText.length && csvText[i + 1] === '"') { currentField += '"'; i++; }
                    else { inQuotes = !inQuotes; }
                } else if (char === ',' && !inQuotes) {
                    fields.push(currentField); currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    fields.push(currentField); rows.push(fields); fields = []; currentField = '';
                    if (char === '\r' && i + 1 < csvText.length && csvText[i + 1] === '\n') i++;
                } else { currentField += char; }
            }
            if (fields.length > 0 || currentField !== '') { fields.push(currentField); rows.push(fields); }
            return rows.map(row => row.map(field => field.trim()));
        }

        // --- INICIALIZACI√ìN DE DATOS ---
        async function loadData() {
            try {
                const [sitesRes, eventsRes] = await Promise.all([fetch(CSV_URL), fetch(EVENTOS_CSV_URL)]);
                const sitesRaw = parseCSV(await sitesRes.text()).slice(1);
                const eventsRaw = parseCSV(await eventsRes.text()).slice(1);

                const sitesProcessed = sitesRaw.map(row => {
                    let type = 'pintxos';
                    const rawType = (row[COLS.tipositio] || '').toLowerCase();

                    if (rawType.includes('Bar') || rawType.includes('Bar y Restaurante')) type = 'pintxos';
                    else if (rawType.includes('Restaurante') || rawType.includes('Bar y Restaurante')) type = 'restaurantes';
                    else if (rawType.includes('bodega') || rawType.includes('vino')) type = 'bodegas';
                    else if (rawType.includes('turismo') || rawType.includes('visita')) type = 'turismo';
                    else if (rawType.includes('tienda') || rawType.includes('comercio')) type = 'tiendas';
                    else if (rawType.includes('curiosidad') || rawType.includes('se√±al')) type = 'curiosidades';

                    const gallery = [];
                    for (let i = 1; i <= 40; i++) {
                        const photoIdx = 24 + (i - 1) * 2;
                        const textIdx = 25 + (i - 1) * 2;
                        if (row[photoIdx]) {
                            gallery.push({
                                url: `https://drive.google.com/thumbnail?id=${row[photoIdx]}&sz=w800`,
                                caption: row[textIdx] || ''
                            });
                        }
                    }

                    let rawVal = String(row[COLS.valoracion] || '100').replace(',', '.');
                    let valNum = parseFloat(rawVal);
                    let finalRating = (isNaN(valNum) || valNum < 100) ? 0 : (valNum - 100) / 10;
                    return {
                        id: row[COLS.idsitio] || Math.random().toString(),
                        type: type,
                        name: row[COLS.sitio],
                        autonomia: row[COLS.autonomia],
                        provincia: row[COLS.provincia],
                        ciudad: row[COLS.ciudad],
                        barrio: row[COLS.barrio],
                        rating: finalRating,
                        image: gallery[0] ? gallery[0].url : 'https://placehold.co/600x400?text=Sin+Foto',
                        desc: row[COLS.barbreve] || 'Sin descripci√≥n disponible.', 
                        fullDesc: row[COLS.bardetalle] || '', 
                        priceCode: row[COLS.codprecio],
                        address: row[COLS.direccion],
                        hours: row[COLS.horario],
                        links: {
                            maps: row[COLS.maps],
                            web: row[COLS.web],
                            instagram: row[COLS.instagram],
                            post: row[COLS.postinstagram],
                            reviews: row[COLS.googleresenas]
                        },
                        gallery: gallery
                    };
                });

                const eventsProcessed = eventsRaw.map((row, idx) => ({
                    id: `evt-${idx}`,
                    type: 'eventosCulinarios',
                    name: row[COLS_EVENTOS.eventoCulinario],
                    mes: row[COLS_EVENTOS.eventoMes],
                    desc: row[COLS_EVENTOS.eventoCulinarioDescripcion],
                    image: row[COLS_EVENTOS.foto1] ? `https://drive.google.com/thumbnail?id=${row[COLS_EVENTOS.foto1]}&sz=w800` : 'https://placehold.co/600x400?text=Evento',
                    rating: 5
                }));

                DATA = [...sitesProcessed, ...eventsProcessed];

                document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
                initApp();

            } catch (err) {
                console.error("Error cargando datos:", err);
                const loadingText = document.getElementById('loading-text');
                const loader = document.querySelector('.loader');
                if (loader) loader.style.display = 'none';
                if (loadingText) {
                    loadingText.innerHTML = `
                        <span class="text-red-600 font-bold">¬°Ups! Algo fall√≥.</span><br>
                        <span class="text-sm text-red-400">${escapeHtml(err.message)}</span><br>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-darkTeal transition-colors font-bold">
                            Reintentar
                        </button>
                    `;
                }
            }
        }

        function initApp() {
            renderSidebar();
            navigate('landing');
            refreshIcons();
        }

        // --- NAVEGACI√ìN Y UI ---

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function navigate(viewId) {
            state.view = viewId;
            state.filters = {};
            state.selectedItem = null;
            state.filterStep = 0;

            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');

            updateActiveMenu(viewId);
            renderAppContent();
        }

        function updateActiveMenu(viewId) {
            renderSidebar();
        }

        function renderSidebar() {
            const container = document.getElementById('nav-menu');
            container.innerHTML = MENUS.map(item => `
                <button onclick="navigate('${item.id}')" class="w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl transition-all duration-200 group ${state.view === item.id ? 'bg-primary text-white shadow-lg shadow-teal-900/50 translate-x-1' : 'hover:bg-teal-800/50 text-teal-100 hover:text-white hover:translate-x-1'}">
                    <i data-lucide="${item.icon}" class="${state.view === item.id ? 'text-teal-50' : 'text-teal-300'}"></i>
                    <span class="font-medium">${item.label}</span>
                </button>
            `).join('');
            refreshIcons();
        }

        function renderAppContent() {
            const container = document.getElementById('app-content');
            container.innerHTML = '';

            let htmlContent = '';

            if (state.selectedItem) {
                htmlContent = getDetailHtml(state.selectedItem);
            } else if (state.view === 'landing') {
                htmlContent = getLandingHtml();
            } else {
                const type = state.view;
                if (['eventosCulinarios', 'eventosTuristicos'].includes(type)) {
                    htmlContent = getSectionMonthHtml(type);
                } else if (['tiendas', 'curiosidades'].includes(type)) {
                    htmlContent = getSectionAlphaHtml(type);
                } else {
                    htmlContent = getSectionLocationHtml(type);
                }
            }
            container.innerHTML = htmlContent;
            refreshIcons();
            container.scrollTo(0, 0);
        }

        // --- VISTAS ---

        function getLandingHtml() {
            const cards = MENUS.filter(m => m.id !== 'landing');

            // Mapa de clases completas para TailwindCSS (CDN no soporta clases din√°micas)
            const colorClasses = {
                orange: 'bg-orange-50 hover:bg-orange-100 border-orange-200 text-orange-600',
                red: 'bg-red-50 hover:bg-red-100 border-red-200 text-red-600',
                purple: 'bg-purple-50 hover:bg-purple-100 border-purple-200 text-purple-600',
                blue: 'bg-blue-50 hover:bg-blue-100 border-blue-200 text-blue-600',
                green: 'bg-green-50 hover:bg-green-100 border-green-200 text-green-600',
                teal: 'bg-teal-50 hover:bg-teal-100 border-teal-200 text-teal-600',
                pink: 'bg-pink-50 hover:bg-pink-100 border-pink-200 text-pink-600',
                yellow: 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200 text-yellow-600'
            };
            const colors = Object.keys(colorClasses);

            return `
                <div class="fade-in max-w-6xl mx-auto">
                    <section class="relative h-[400px] rounded-3xl overflow-hidden mb-10 shadow-2xl">
                        <img src="https://drive.google.com/thumbnail?id=1_ac1UF-huYLYVO2pCSK-eFqk3k67l3zZ&sz=w1200-h800" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-darkTeal/90 to-transparent flex flex-col justify-end p-8 text-center">
                            <h1 class="font-brand text-4xl md:text-6xl text-white mb-2 text-shadow">Gastronom√≠a y turismo</h1>
                            <p class="text-teal-100 text-lg md:text-xl font-light">Compartimos nuestras experiencias, por si te apetece probar alguna...</p>
                        </div>
                    </section>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${cards.map((c, idx) => {
                const color = colors[idx % colors.length];
                const classes = colorClasses[color].split(' ');
                const bgClass = classes[0];
                const hoverBgClass = classes[1];
                const borderClass = classes[2];
                const iconClass = classes[3];

                return `
                            <button onclick="navigate('${escapeHtml(c.id)}')" class="${bgClass} ${hoverBgClass} border ${borderClass} p-6 rounded-3xl shadow-sm hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center aspect-square text-center group cursor-pointer w-full">
                                <div class="bg-white p-4 rounded-full mb-4 shadow-sm group-hover:scale-110 transition-transform duration-300">
                                    <i data-lucide="${c.icon}" class="${iconClass}" width="32" height="32"></i>
                                </div>
                                <span class="font-bold text-slate-800 group-hover:text-darkTeal font-brand text-lg">${escapeHtml(c.label)}</span>
                            </button>
                        `}).join('')}
                    </div>

                    <div class="mt-16 bg-white rounded-3xl p-8 shadow-lg flex flex-col md:flex-row items-center gap-8">
                         <img src="https://drive.google.com/thumbnail?id=16FRveDGCnFoiLNLkAADY3MblBrIgYhWX&sz=w400" class="w-40 h-32 rounded-2xl object-cover border-4 border-primary">
                         <div class="text-center md:text-left">
                            <h2 class="font-brand text-2xl text-darkTeal mb-2">¬°Hola! Somos Angels e I√±aki üëã</h2>
                            <p class="text-gray-600">Te abrimos las puertas a nuestro universo. Tenemos de todo: desde bocados de pura felicidad üòã, hasta kil√≥metros de aventura ‚ú®.</p>
                         </div>
                    </div>
                </div>
            `;
        }

        // --- FILTROS Y GRID ---

        function selectFilter(level, value) {
            state.filters[level] = value;
            state.filterStep++;
            renderAppContent();
        }

        function resetFilters() {
            state.filters = {};
            state.filterStep = 0;
            renderAppContent();
        }

        function showAllFilters() {
            state.filterStep = 99;
            renderAppContent();
        }

        function goBackOneStep() {
            const levels = ['autonomia', 'provincia', 'ciudad', 'barrio'];
            const currentType = state.view;

            if (state.filterStep === 0 && Object.keys(state.filters).length === 0) {
                navigate('landing');
                return;
            }

            if (state.filterStep === 99) {
                const activeFilters = levels.filter(l => state.filters[l]);
                if (activeFilters.length === 0) {
                    // No hay filtros activos, volver al inicio
                    navigate('landing');
                } else {
                    // Hay filtros activos, volver al √∫ltimo paso de filtrado
                    state.filterStep = activeFilters.length - 1;
                    renderAppContent();
                }
                return;
            }

            const activeFilters = levels.filter(l => state.filters[l]);

            if (activeFilters.length > 0) {
                const lastFilter = activeFilters[activeFilters.length - 1];
                delete state.filters[lastFilter];
                state.filterStep = activeFilters.length - 1;
            } else {
                state.filterStep = Math.max(0, state.filterStep - 1);
            }

            const currentData = DATA.filter(d => d.type === currentType &&
                Object.keys(state.filters).every(k => d[k] === state.filters[k])
            );

            if (state.filterStep < levels.length) {
                const currentLevel = levels[state.filterStep];
                const options = [...new Set(currentData.map(item => item[currentLevel]))].filter(Boolean);

                if (options.length <= 1 && (state.filterStep > 0 || Object.keys(state.filters).length > 0)) {
                    goBackOneStep();
                    return;
                }
            }

            renderAppContent();
        }

        function getSectionLocationHtml(type) {
            const levels = ['autonomia', 'provincia', 'ciudad', 'barrio'];

            const currentData = DATA.filter(d => d.type === type &&
                Object.keys(state.filters).every(k => d[k] === state.filters[k])
            );

            const sectionTitle = MENUS.find(m => m.id === type)?.label || type;

            while (state.filterStep < levels.length) {
                let currentLevel = levels[state.filterStep];
                const options = [...new Set(currentData.map(item => item[currentLevel]))].filter(Boolean).sort();

                if (options.length === 0) {
                    state.filterStep = 99;
                    break;
                } else if (options.length === 1) {
                    state.filters[currentLevel] = options[0];
                    state.filterStep++;
                } else {
                    return renderFilterWizard(sectionTitle, currentLevel, options);
                }
            }

            return renderResultsGrid(sectionTitle, currentData);
        }

        function renderFilterWizard(title, level, options) {
            const levelLabel = level.charAt(0).toUpperCase() + level.slice(1);

            return `
                <div class="fade-in max-w-lg mx-auto p-6 mt-4">
                    <button onclick="goBackOneStep()" class="mb-6 flex items-center text-slate-500 font-bold hover:text-primary transition-colors">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center mr-2 group-hover:bg-primary/10">
                            <i data-lucide="arrow-left" width="18"></i>
                        </div>
                        Atr√°s / Anterior
                    </button>

                    <h2 class="text-3xl font-brand font-bold mb-2 text-center text-darkTeal">
                        ${title}
                    </h2>
                    <p class="text-center text-gray-500 mb-8">Selecciona ${levelLabel}:</p>
                    
                    <div class="space-y-3">
                        ${options.map(opt => `
                            <button onclick="selectFilter('${level}', '${opt}')" class="w-full p-5 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:border-teal-400 hover:bg-teal-50 transition-all bg-white group text-slate-700">
                                <span class="text-lg font-medium">${opt}</span>
                                <i data-lucide="chevron-right" class="text-gray-300 group-hover:text-primary transition-colors"></i>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <button onclick="showAllFilters()" class="w-full py-4 rounded-xl bg-primary text-white font-bold shadow-lg shadow-teal-500/20 hover:bg-darkTeal transition-all">
                            Mostrar todos los resultados
                        </button>
                    </div>
                </div>
            `;
        }

        function getSectionMonthHtml(type) {
            const rawData = DATA.filter(d => d.type === type);
            const monthsOrder = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            const grouped = rawData.reduce((acc, item) => {
                const m = item.mes || 'Sin Fecha';
                (acc[m] = acc[m] || []).push(item);
                return acc;
            }, {});

            const sortedMonths = Object.keys(grouped).sort((a, b) => {
                const idxA = monthsOrder.indexOf(a);
                const idxB = monthsOrder.indexOf(b);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });

            const title = MENUS.find(m => m.id === type)?.label || type;

            return `
                <div class="fade-in pb-24">
                    <header class="mb-8 border-b-4 border-secondary inline-block pb-2">
                        <h1 class="text-3xl font-brand font-bold text-darkTeal">${title}</h1>
                    </header>
                    <div class="space-y-12">
                        ${sortedMonths.map(month => `
                            <div class="relative">
                                <div class="sticky top-0 z-10 bg-[#F0FDFD]/95 backdrop-blur py-3 mb-4 border-b border-teal-100 flex items-center">
                                    <span class="bg-primary text-white px-3 py-1 rounded-lg text-sm font-bold uppercase tracking-wider mr-3">${month}</span>
                                    <span class="text-gray-400 text-sm">${grouped[month].length} eventos</span>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${grouped[month].map(item => renderCard(item)).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getSectionAlphaHtml(type) {
            const rawData = DATA.filter(d => d.type === type).sort((a, b) => a.name.localeCompare(b.name));
            const title = MENUS.find(m => m.id === type)?.label || type;
            return renderResultsGrid(title, rawData, false);
        }

        function renderResultsGrid(title, items, showFilterBtn = true) {
            if (items.length === 0) {
                return `
                      <div class="fade-in pb-24">
                         <header class="mb-8 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <button onclick="goBackOneStep()" class="p-2 bg-white rounded-full border border-gray-200 hover:border-primary hover:text-primary transition"><i data-lucide="arrow-left"></i></button>
                                <h1 class="text-3xl font-brand font-bold text-darkTeal">${title}</h1>
                            </div>
                            ${showFilterBtn ? `<button onclick="resetFilters()" class="text-sm font-medium text-primary hover:underline">Reiniciar Todo</button>` : ''}
                         </header>
                         <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-gray-300">
                             <div class="bg-gray-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                                <i data-lucide="search" width="32" height="32"></i>
                             </div>
                             <p class="text-gray-500 font-medium text-lg">No hemos encontrado nada aqu√≠.</p>
                             <button onclick="goBackOneStep()" class="text-primary font-bold mt-4 border border-primary px-4 py-2 rounded-full hover:bg-primary hover:text-white transition">Volver atr√°s</button>
                         </div>
                      </div>
                `;
            }

            const hasFilters = Object.keys(state.filters).length > 0;
            // ESTA ES LA L√çNEA QUE FALTABA:
            const canGoBack = hasFilters || state.filterStep === 99;

            return `
                <div class="fade-in pb-24">
                    <header class="mb-8">
                        <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4">
                            <div class="flex items-start gap-4">
                                ${canGoBack ? `
                                <button onclick="goBackOneStep()" class="mt-1 p-2 bg-white rounded-full shadow-sm border border-gray-200 hover:bg-primary hover:text-white transition-colors group" title="Volver un paso">
                                    <i data-lucide="arrow-left" width="20"></i>
                                </button>
                                ` : ''}
                                
                                <div>
                                    <h1 class="text-3xl font-brand font-bold text-darkTeal">${title}</h1>
                                    <p class="text-gray-500 text-sm mt-1">Mostrando ${items.length} resultados</p>
                                </div>
                            </div>

                            ${showFilterBtn && hasFilters ? `
                                <div class="flex items-center gap-2 flex-wrap justify-end">
                                    <span class="text-xs text-gray-400 bg-white px-2 py-1 rounded border hidden md:inline-block">
                                        ${Object.values(state.filters).join(' > ')}
                                    </span>
                                    <button onclick="resetFilters()" class="text-xs font-bold text-teal-600 bg-teal-50 px-3 py-2 rounded-lg hover:bg-teal-100 transition-colors">
                                        Borrar todo
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </header>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${items.map(item => renderCard(item)).join('')}
                    </div>
                </div>
            `;
        }

        function renderCard(item) {
            const rating = Math.round(item.rating * 2) / 2;
            const starHtml = Array(5).fill(0).map((_, i) => {
                const diff = rating - i;
                if (diff >= 1) {
                    // Estrella completa
                    return `<svg class="w-6 h-6 text-yellow-400 fill-current" viewBox="0 0 24 24" stroke="currentColor" stroke-width="0"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                } else if (diff >= 0.5) {
                    // Media estrella (con degradado)
                    const gradId = `grad-${Math.random().toString(36).substr(2, 9)}`;
                    return `<svg class="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" stroke="currentColor" stroke-width="0">
                        <defs>
                            <linearGradient id="${gradId}">
                                <stop offset="50%" stop-color="currentColor"/>
                                <stop offset="50%" stop-color="#2bbbad"/>
                            </linearGradient>
                        </defs>
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="url(#${gradId})"></polygon>
                    </svg>`;
                } else {
                    // Estrella vac√≠a
                    return `<svg class="w-6 h-6 text-teal-400 fill-current" viewBox="0 0 24 24" stroke="currentColor" stroke-width="0"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                }
            }).join('');

            return `
                <div onclick="openDetail('${item.id}')" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer group flex flex-col h-full">
                    <div class="h-48 overflow-hidden relative">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                        <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur-sm text-darkTeal px-3 py-1 text-xs font-bold rounded-lg shadow-sm">
                            ${item.ciudad || item.provincia || 'General'}
                        </div>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="mb-2">
                             <h3 class="text-lg font-bold text-slate-800 leading-snug group-hover:text-primary transition-colors font-brand">${item.name}</h3>
                             ${item.mes ? `<span class="text-xs font-bold uppercase tracking-wide text-secondary mt-1 block">${item.mes}</span>` : ''}
                        </div>
                        
                        <p class="text-gray-500 text-sm line-clamp-2 mb-4 flex-1 font-light leading-relaxed">${item.desc}</p>
                        
                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
                            <div class="flex items-center space-x-1">${starHtml}</div>
                            <span class="w-8 h-8 rounded-full bg-surface flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors">
                                <i data-lucide="chevron-right" width="16"></i>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- VISTA DETALLE ---

        function openDetail(id) {
            state.selectedItem = DATA.find(d => d.id === id);
            // Prevenir scroll del body en m√≥vil
            document.body.style.overflow = 'hidden';
            renderAppContent();
        }

        function closeDetail() {
            state.selectedItem = null;
            // Restaurar scroll del body
            document.body.style.overflow = '';
            renderAppContent();
        }

        function getDetailHtml(item) {
            const rating = Math.round(item.rating * 2) / 2;
            const starHtml = Array(5).fill(0).map((_, i) => {
                const diff = rating - i;
                if (diff >= 1) {
                    // Estrella completa
                    return `<svg class="w-11 h-11 text-yellow-400 fill-current" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                } else if (diff >= 0.5) {
                    // Media estrella
                    const gradId = `grad-detail-${Math.random().toString(36).substr(2, 9)}`;
                    return `<svg class="w-11 h-11 text-yellow-400" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="${gradId}">
                                <stop offset="50%" stop-color="currentColor"/>
                                <stop offset="50%" stop-color="#2bbbad"/>
                            </linearGradient>
                        </defs>
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="url(#${gradId})"></polygon>
                    </svg>`;
                } else {
                    // Estrella vac√≠a
                    return `<svg class="w-11 h-11 text-teal-400 fill-current" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                }
            }).join('');

            const locationStr = [item.direccion, item.ciudad, item.provincia].filter(Boolean).join(', ');

            let priceText = '';
            if (item.priceCode == PRICE_CODES.VERY_GOOD) priceText = '<span class="text-green-600 font-bold bg-green-50 px-2 py-1 rounded">Precio Muy Bueno ‚úÖ</span>';
            else if (item.priceCode == PRICE_CODES.FAIR) priceText = '<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">Precio Justo ‚öñÔ∏è</span>';
            else if (item.priceCode == PRICE_CODES.EXPENSIVE) priceText = '<span class="text-red-600 font-bold bg-red-50 px-2 py-1 rounded">Precio Caro üíÄ</span>';

            const remainingGallery = item.gallery.slice(1);

            // CAMBIO AQU√ç: Se a√±ade 'fixed inset-0 z-[60]' para m√≥vil, y 'md:absolute md:z-20' para escritorio.
            // Esto hace que en el m√≥vil la ficha tape el men√∫ verde superior.
            return `
                <div class="bg-white min-h-full fixed inset-0 z-[60] md:absolute md:z-20 md:inset-0 overflow-y-auto animate-fadeIn pb-20">
                    
                    <button onclick="closeDetail()" class="fixed top-4 left-4 md:left-[280px] z-[70] bg-white/90 backdrop-blur p-3 rounded-full shadow-2xl hover:bg-primary hover:text-white transition-all group border border-gray-100 flex items-center gap-2 pr-4">
                        <i data-lucide="arrow-left" class="group-hover:-translate-x-1 transition-transform"></i>
                        <span class="font-bold text-sm hidden sm:inline">Volver</span>
                    </button>
                    
                    <div class="h-[50vh] w-full relative cursor-pointer group" onclick="openLightbox(0)">
                        <img src="${item.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent pointer-events-none"></div>
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
                             <span class="bg-black/50 text-white px-4 py-2 rounded-full backdrop-blur text-sm font-bold">Ver Galer√≠a</span>
                        </div>
                        <div class="absolute bottom-0 left-0 w-full p-6 pb-12 md:p-12 pointer-events-none">    
                            <div class="max-w-4xl mx-auto">
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-4 bg-primary text-white shadow-lg border border-white/20">
                                    ${MENUS.find(m => m.id === item.type)?.label || item.type}
                                </span>
                                <h2 class="font-brand text-4xl md:text-5xl text-white mb-2 leading-tight drop-shadow-lg">${item.name}</h2>
                                <p class="text-gray-200 text-sm md:text-base flex items-center font-medium opacity-90">
                                    <i data-lucide="map-pin" width="16" class="mr-2 text-primaryContainer"></i> ${item.ciudad}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-5xl mx-auto -mt-10 relative px-4 md:px-0">
                        <div class="bg-white rounded-t-3xl shadow-xl border-t border-gray-100 p-6 md:p-10 flex flex-col md:flex-row gap-10">
                            
                            <div class="flex-1 space-y-8">
                                
                                <div class="flex flex-wrap items-center justify-between gap-4 border-b border-dashed border-gray-200 pb-6">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-4xl font-brand text-darkTeal font-bold">${item.rating.toString().replace('.', ',')}</span>
                                        <div class="flex">${starHtml}</div>
                                    </div>
                                    ${priceText}
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-darkTeal mb-3 font-brand uppercase tracking-widest">Nuestra Experiencia</h3>
                                    <div class="prose prose-teal text-gray-600 leading-loose text-lg font-light">
                                        ${item.fullDesc || item.desc}
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-3">
                                    ${item.links.maps ? `<a href="${item.links.maps}" target="_blank" class="flex-1 min-w-[140px] text-center bg-gray-100 hover:bg-green-100 text-gray-800 hover:text-green-800 py-3 rounded-xl font-bold transition flex justify-center items-center gap-2"><i data-lucide="map"></i> Ver Mapa</a>` : ''}
                                    ${item.links.web ? `<a href="${item.links.web}" target="_blank" class="flex-1 min-w-[140px] text-center bg-gray-100 hover:bg-blue-100 text-gray-800 hover:text-blue-800 py-3 rounded-xl font-bold transition flex justify-center items-center gap-2"><i data-lucide="globe"></i> Web</a>` : ''}
                                    ${item.links.instagram ? `<a href="${item.links.instagram}" target="_blank" class="flex-1 min-w-[140px] text-center bg-gray-100 hover:bg-pink-100 text-gray-800 hover:text-pink-800 py-3 rounded-xl font-bold transition flex justify-center items-center gap-2"><i data-lucide="camera"></i> Instagram</a>` : ''}
                                </div>
                            </div>

                            <div class="w-full md:w-80 flex-shrink-0 space-y-6">
                                <div class="bg-[#F0FDFD] p-6 rounded-2xl border border-teal-100 shadow-sm sticky top-6">
                                    <h4 class="text-xs font-bold text-teal-800 uppercase mb-4 tracking-wider flex items-center border-b border-teal-200 pb-2">
                                        <i data-lucide="info" width="14" class="mr-2"></i> Datos Pr√°cticos
                                    </h4>
                                    
                                    ${item.address ? `
                                    <div class="mb-4">
                                        <span class="text-xs text-gray-400 font-bold uppercase">Direcci√≥n</span>
                                        <p class="text-sm font-medium text-slate-700 mt-1">${item.address}</p>
                                    </div>` : ''}

                                    ${item.hours ? `
                                    <div class="mb-4">
                                        <span class="text-xs text-gray-400 font-bold uppercase">Horario</span>
                                        <div class="text-sm font-medium text-slate-700 mt-1 whitespace-pre-line">${item.hours}</div>
                                    </div>` : ''}

                                    ${item.links.reviews ? `
                                    <a href="${item.links.reviews}" target="_blank" class="block w-full text-center bg-white border border-teal-200 text-primary py-2 rounded-lg text-sm font-bold hover:bg-primary hover:text-white transition mt-6">
                                        Leer Rese√±as en Google
                                    </a>` : ''}
                                </div>
                            </div>
                        </div>

                        ${remainingGallery.length > 0 ? `
                        <div class="mt-12 mb-12">
                            <h3 class="text-2xl font-brand font-bold text-darkTeal mb-6 pl-4 border-l-4 border-secondary">Galer√≠a de Fotos</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${remainingGallery.map((img, idx) => `
                                    <div onclick="openLightbox(${idx + 1})" class="aspect-square rounded-xl overflow-hidden cursor-pointer hover:opacity-90 transition shadow-md group relative hover:ring-4 hover:ring-primary/30">
                                        <img src="${img.url}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500" loading="lazy">
                                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>
                                        <div class="absolute bottom-2 right-2 bg-black/50 backdrop-blur text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i data-lucide="maximize-2" width="16" height="16"></i>
                                        </div>
                                        ${img.caption ? `<div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 to-transparent text-white text-[10px] p-3 pt-6 opacity-0 group-hover:opacity-100 transition translate-y-2 group-hover:translate-y-0 font-medium truncate">${img.caption}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        // --- L√ìGICA DEL LIGHTBOX ---
        let currentLightboxIndex = 0;

        function openLightbox(index) {
            if (!state.selectedItem || !state.selectedItem.gallery) return;

            currentLightboxIndex = index;
            const lightbox = document.getElementById('lightbox');

            lightbox.classList.remove('hidden');
            setTimeout(() => {
                lightbox.classList.remove('opacity-0');
            }, 10);

            updateLightboxContent();

            document.addEventListener('keydown', handleLightboxKeys);
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.add('opacity-0');

            setTimeout(() => {
                lightbox.classList.add('hidden');
            }, 300);

            document.removeEventListener('keydown', handleLightboxKeys);
            document.body.style.overflow = '';
        }

        function changeLightboxSlide(direction) {
            const gallery = state.selectedItem.gallery;
            currentLightboxIndex += direction;

            if (currentLightboxIndex >= gallery.length) currentLightboxIndex = 0;
            if (currentLightboxIndex < 0) currentLightboxIndex = gallery.length - 1;

            updateLightboxContent();
        }

        function updateLightboxContent() {
            const gallery = state.selectedItem.gallery;
            const item = gallery[currentLightboxIndex];

            const imgEl = document.getElementById('lightbox-img');
            const captionEl = document.getElementById('lightbox-caption');
            const counterEl = document.getElementById('lightbox-counter');

            imgEl.style.opacity = '0.5';
            setTimeout(() => imgEl.style.opacity = '1', 200);

            imgEl.src = item.url;

            if (item.caption) {
                captionEl.textContent = item.caption;
                captionEl.style.display = 'block';
            } else {
                captionEl.style.display = 'none';
            }

            counterEl.textContent = `${currentLightboxIndex + 1} de ${gallery.length}`;
        }

        function handleLightboxKeys(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') changeLightboxSlide(-1);
            if (e.key === 'ArrowRight') changeLightboxSlide(1);
        }

        // --- INICIAR ---
        document.addEventListener('DOMContentLoaded', loadData);

    </script>

    <div id="lightbox"
        class="fixed inset-0 z-[100] bg-black/95 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center backdrop-blur-sm"
        onclick="if(event.target === this) closeLightbox()">

        <button onclick="closeLightbox()"
            class="absolute top-4 right-4 text-white/70 hover:text-white hover:bg-white/10 rounded-full p-2 transition-all z-50">
            <i data-lucide="x" width="32" height="32"></i>
        </button>

        <button onclick="changeLightboxSlide(-1)"
            class="absolute left-2 md:left-8 text-white/70 hover:text-white hover:scale-110 transition-all p-2 z-50 bg-black/20 hover:bg-black/50 rounded-full">
            <i data-lucide="chevron-left" width="40" height="40"></i>
        </button>

        <div
            class="relative max-w-7xl max-h-screen w-full h-full flex flex-col items-center justify-center p-4 md:p-10">

            <img id="lightbox-img" src=""
                class="max-h-[80vh] max-w-full object-contain shadow-2xl rounded-md select-none transition-transform duration-300"
                alt="Galer√≠a">

            <div id="lightbox-caption-container"
                class="absolute bottom-8 left-0 right-0 text-center pointer-events-none">
                <div class="inline-block bg-black/60 backdrop-blur-md text-white px-6 py-3 rounded-full max-w-[90%]">
                    <p id="lightbox-caption" class="text-sm md:text-lg font-brand tracking-wide"></p>
                    <p id="lightbox-counter" class="text-xs text-white/60 mt-1 font-sans uppercase tracking-widest"></p>
                </div>
            </div>
        </div>

        <button onclick="changeLightboxSlide(1)"
            class="absolute right-2 md:right-8 text-white/70 hover:text-white hover:scale-110 transition-all p-2 z-50 bg-black/20 hover:bg-black/50 rounded-full">
            <i data-lucide="chevron-right" width="40" height="40"></i>
        </button>
    </div>
</body>

</html>
