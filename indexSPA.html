<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANeKI - Gastroturismo</title>
    <!-- Favicon -->
    <!-- <link rel="icon" type="image/x-icon" href="./favicon.ico"> -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Special+Elite&display=swap" rel="stylesheet">

    <style type="text/tailwindcss">
        @layer base {
            body {
                font-family: 'Inter', sans-serif;
                background-color: theme('colors.background');
                color: theme('colors.on-surface');
            }
            .font-brand {
                font-family: 'Special Elite', cursive;
            }
            h1, h2, h3, h4, h5, h6 {
                @apply font-brand text-primary;
            }
            .active-link {
                 @apply bg-background text-primary font-bold;
            }
        }
        @layer components {
            .simple-loader {
                border: 5px solid theme('colors.surface');
                border-top: 5px solid theme('colors.primary');
                border-radius: 50%;
                width: 48px;
                height: 48px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .gallery-container {
                position: relative; max-width: 900px; margin: 20px auto;
            }
            .mySlides { display: none; }
            .mySlides img { vertical-align: middle; }
            .cursor { cursor: pointer; }
            .prev, .next {
                cursor: pointer; position: absolute; top: 50%; width: auto;
                padding: 16px; margin-top: -50px; color: theme('colors.on-surface');
                font-weight: bold; font-size: 20px; border-radius: 0 3px 3px 0;
                user-select: none; background-color: theme('colors.background');
                transition: background-color 0.6s ease;
            }
            .next { right: 0; border-radius: 3px 0 0 3px; }
            .prev:hover, .next:hover { background-color: theme('colors.primary'); color: white; }
            .numbertext {
                color: theme('colors.on-surface'); font-size: 12px; font-weight: bold;
                padding: 8px 12px; position: absolute; top: 0;
                background-color: theme('colors.background'); border-radius: 0 0 5px 0;
            }
            .caption-container {
                text-align: center; background-color: #222; padding: 2px 16px;
                color: white; margin-top: -4px; font-family: 'Special Elite', cursive;
            }
            .row:after { content: ""; display: table; clear: both; }
            .column { float: left; padding: 5px; } /* width set dynamically */
            .demo { opacity: 0.6; transition: opacity 0.3s ease; }
            .active, .demo:hover { opacity: 1; }
            .modal-overlay { transition: opacity 0.3s ease; }
            .modal-content { animation: zoomIn 0.3s ease; }
            @keyframes zoomIn { from {transform: scale(0.8);} to {transform: scale(1);} }
            #modal-caption {
                font-family: 'Special Elite', cursive;
                transition: opacity 0.3s ease 0.2s, transform 0.3s ease 0.2s;
            }
        }
    </style>

    <script>
        // Tailwind Config
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        brand: ['Special Elite', 'cursive'],
                    },
                    colors: {
                        primary: '#009688', 'on-primary': '#FFFFFF',
                        secondary: '#4DB6AC', 'on-secondary': '#FFFFFF',
                        surface: '#E0F2F1', 'on-surface': '#004D40',
                        background: '#B2DFDB',
                        'primary-container': '#A7FFEB', 'on-primary-container': '#004D40',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background text-on-surface">

    <!-- App Container -->
    <div class="min-h-screen flex flex-col">

        <!-- Header -->
        <header id="app-header" class="fixed top-0 left-0 right-0 bg-surface text-on-surface shadow-md z-30 h-16 transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="menu-btn" aria-label="Abrir men√∫" class="p-2 rounded-md text-on-surface hover:bg-background focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary">
                            <span class="material-icons">menu</span>
                        </button>
                        <span id="header-title" class="font-brand text-2xl text-primary ml-3">ANeKI</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Drawer -->
        <aside id="drawer" class="fixed top-0 left-0 z-40 h-full w-72 bg-surface shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out pt-16">
            <div class="flex flex-col h-full">
                <div class="bg-primary-container p-4">
                    <a href="#" class="nav-link" data-page="home">
                        <h3 class="font-brand text-2xl text-on-primary-container">ANeKI</h3>
                        <h6 class="font-brand text-lg text-on-primary-container opacity-80">Gastroturismo</h6>
                    </a>
                </div>
                <nav id="main-nav" class="flex-grow p-4 space-y-2 overflow-y-auto">
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="home">
                        <span class="material-icons mr-3">home</span><span class="font-brand text-lg">Inicio</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="tapeo">
                        <span class="material-icons mr-3">tapas</span><span class="font-brand text-lg">Tapear</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="restaurantes">
                        <span class="material-icons mr-3">restaurant</span><span class="font-brand text-lg">Restaurantes</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="bodegas">
                        <span class="material-icons mr-3">wine_bar</span><span class="font-brand text-lg">Bodegas</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="turismo">
                        <span class="material-icons mr-3">map</span><span class="font-brand text-lg">Turismo</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="eventos-culinarios">
                        <span class="material-icons mr-3">local_dining</span><span class="font-brand text-lg">Eventos Culinarios</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="eventos-turisticos">
                        <span class="material-icons mr-3">event</span><span class="font-brand text-lg">Eventos Tur√≠sticos</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="tiendas">
                        <span class="material-icons mr-3">storefront</span><span class="font-brand text-lg">Tiendas</span>
                    </a>
                    <a href="#" class="nav-link group flex items-center px-3 py-2 text-on-surface rounded-md hover:bg-background hover:text-primary" data-page="curiosidades">
                        <span class="material-icons mr-3">help_outline</span><span class="font-brand text-lg">Curiosidades</span>
                    </a>
                </nav>
            </div>
        </aside>
        <!-- Scrim -->
        <div id="drawer-scrim" class="fixed inset-0 bg-black bg-opacity-50 z-35 hidden transition-opacity duration-300"></div>

        <!-- Main Content -->
        <main class="pt-16 flex-grow">
            
            <!-- Page: Home -->
            <div id="page-home" class="page-content">
                <section class="min-h-[70vh] bg-cover bg-center flex items-center justify-center text-center text-white relative" style="background-image: url('https://drive.google.com/thumbnail?id=1_ac1UF-huYLYVO2pCSK-eFqk3k67l3zZ&sz=w1200-h800');">
                    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                    <div class="relative z-10 p-5 max-w-3xl">
                        <h1 class="font-brand text-5xl md:text-6xl text-white mb-4">Gastronom√≠a y turismo en tu bolsillo</h1>
                        <p class="text-xl md:text-2xl mb-8 font-brand">Compartimos nuestras experiencias gastron√≥micas y tur√≠sticas, por si te apetece probar alguna...</p>
                        <a href="#categories" class="inline-block bg-primary text-on-primary font-brand text-lg px-6 py-3 rounded-lg shadow-lg hover:bg-secondary transition-colors">
                            ¬°Pasa a ver nuestras recomendaciones! üëá
                        </a>
                    </div>
                </section>
                <section class="py-12 md:py-16 bg-surface">
                    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-8 items-center">
                            <div class="md:col-span-2">
                                <img src="https://drive.google.com/thumbnail?id=16FRveDGCnFoiLNLkAADY3MblBrIgYhWX&sz=w800-h500" alt="Angels e I√±aki" class="w-full h-auto rounded-2xl shadow-lg object-cover">
                            </div>
                            <div class="md:col-span-3 text-center md:text-left">
                                <h2 class="text-3xl md:text-4xl mb-4">¬°Hola! Somos Angels e I√±aki üëã</h2>
                                <p class="text-lg md:text-xl font-brand leading-relaxed">
                                    Te abrimos las puertas a nuestro universo.<br>Tenemos de todo: desde bocados de pura felicidad üòã, hasta kil√≥metros de aventura ‚ú® y carteles que nos sacan una sonrisa üòÇ.<br>Si buscas un chute de inspiraci√≥n, ¬°est√°s en el sitio perfecto! üéâ
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="categories" class="py-12 md:py-16">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-4xl md:text-5xl text-center mb-12">Descubre Nuestros Mundos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Category Cards -->
                            <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="tapeo">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">tapas</span></div><h3 class="text-2xl mb-2">Pintxos y Tapas üç∑üç¢</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">¬°A gozar! Descubre sitios donde ofrecen buenos pintxos o tapas, de los que te hacen salivar. üçªüç°</p><span class="font-brand text-primary font-bold">Explorar Tapeo</span></div>
                            </a>
                             <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="restaurantes">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">restaurant</span></div><h3 class="text-2xl mb-2">Restaurantes üçΩÔ∏èüåü</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Desde la cocina casera üëµü•ò hasta esos sitios con soles y estrellas Michelin. ¬°Buen provecho! ü•Ç</p><span class="font-brand text-primary font-bold">Ver Restaurantes</span></div>
                            </a>
                            <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="bodegas">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">wine_bar</span></div><h3 class="text-2xl mb-2">Bodegas üçáüç∑</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Descubre bodegas con encanto que nos han conquistado (y sus caldos tambi√©n, claro). üòâ</p><span class="font-brand text-primary font-bold">Visitar Bodegas</span></div>
                            </a>
                             <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="turismo">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">explore</span></div><h3 class="text-2xl mb-2">Turismo üèûÔ∏èüö∂‚Äç‚ôÄÔ∏è</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Acomp√°√±anos a explorar experiencias tur√≠sticas que nos han marcado ‚ú®. ¬°Prepara la c√°mara! üì∏</p><span class="font-brand text-primary font-bold">Explorar Turismo</span></div>
                            </a>
                            <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="eventos-culinarios">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">local_dining</span></div><h3 class="text-2xl mb-2">Eventos Culinarios üéâ üßë‚Äçüç≥</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Ferias, men√∫s tem√°ticos, maridajes... ¬°Revive los mejores momentos culinarios! ü•≥</p><span class="font-brand text-primary font-bold">Ver Eventos Culinarios</span></div>
                            </a>
                             <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="eventos-turisticos">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">festival</span></div><h3 class="text-2xl mb-2">Eventos Tur√≠sticos üè∞üé∂</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Mercados medievales, festivales, ferias locales... ¬°Rememora los momentos tur√≠sticos m√°s top! üöÄ</p><span class="font-brand text-primary font-bold">Ver Eventos Tur√≠sticos</span></div>
                            </a>
                            <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="tiendas">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">storefront</span></div><h3 class="text-2xl mb-2">Compras Gourmet üõçÔ∏èüéÅ</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">¬°Para los paladares finos! Descubre tiendas gourmet que nos encantan. üíé</p><span class="font-brand text-primary font-bold">Ver Tiendas</span></div>
                            </a>
                            <a href="#" class="nav-link block bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300" data-page="curiosidades">
                                <div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex"><span class="material-icons text-4xl">emoji_objects</span></div><h3 class="text-2xl mb-2">Curiosidades ü§™üõë</h3><p class="font-brand text-on-surface opacity-80 text-base mb-4 flex-grow">Coleccionamos esos carteles y se√±ales curiosas que te alegran el paseo. üòÑ</p><span class="font-brand text-primary font-bold">Ver Curiosidades</span></div>
                            </a>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Page: Tapeo -->
            <div id="page-tapeo" class="page-content hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div id="tapeo-selector">
                        <div class="mb-5">
                            <div class="flex items-center min-h-[40px] mb-4">
                                <button id="tapeo-back-button" class="hidden bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors items-center">
                                    <span class="material-icons mr-2">arrow_back</span>ATR√ÅS
                                </button>
                                <div id="tapeo-breadcrumbs" class="ml-4 font-brand text-lg text-primary opacity-70"></div>
                            </div>
                            <h2 id="tapeo-title" class="text-3xl md:text-4xl text-left m-0"></h2>
                        </div>
                        <div id="tapeo-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        <div id="tapeo-loading" class="flex flex-col items-center justify-center p-10">
                            <div class="simple-loader" role="progressbar" aria-label="Cargando"></div>
                            <p class="font-brand text-2xl text-primary mt-4">Cargando datos...</p>
                        </div>
                        <div id="tapeo-error" class="hidden p-10"></div>
                    </div>
                    <div id="tapeo-detail-container" class="hidden"></div>
                </div>
            </div>

            <!-- Placeholder Pages -->
            <div id="page-restaurantes" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Restaurantes</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-bodegas" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Bodegas</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-turismo" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Turismo</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-eventos-culinarios" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Eventos Culinarios</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-eventos-turisticos" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Eventos Tur√≠sticos</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-tiendas" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Tiendas</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>
            <div id="page-curiosidades" class="page-content hidden"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h2 class="text-4xl text-center">Curiosidades</h2><p class="font-brand text-xl text-center mt-4">Contenido pr√≥ximamente...</p></div></div>

        </main>

        <!-- Footer -->
        <footer class="bg-surface text-on-surface text-center p-3 mt-auto">
            <span id="footer-year"></span> ANeKI Gastroturismo.
        </footer>

    </div>

    <!-- FAB (Chatbot) -->
    <div class="fixed bottom-6 right-6 z-20">
        <a href="https://notebooklm.google.com/notebook/6b38dfab-ba8b-449f-a4f3-48154aaa29e4" target="_blank" rel="noopener noreferrer" title="Habla con tu Colega del Tapeo üòâ" class="flex items-center justify-center w-14 h-14 bg-primary text-background rounded-full shadow-lg transform hover:scale-110 hover:bg-background hover:text-primary transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="28px" viewBox="0 0 24 24" width="28px" fill="currentColor" aria-hidden="true"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M20,2H4C2.9,2,2,2.9,2,4v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M20,16H5.17L4,17.17V4h16V16z"/><circle cx="12" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/><circle cx="8" cy="10" r="1.5"/></g></g></svg>
            <span class="sr-only">Habla con tu Colega del Tapeo (abre en una nueva pesta√±a)</span>
        </a>
    </div>

    <!-- Modal para Fotos -->
    <div id="photo-modal" class="modal-overlay hidden fixed inset-0 z-50 bg-black bg-opacity-80 items-center justify-center p-4" onclick="app.gallery.closeModal()">
        <span class="modal-close absolute top-2 right-4 text-white text-6xl font-light cursor-pointer" onclick="event.stopPropagation(); app.gallery.closeModal()">&times;</span>
        <img class="modal-content max-w-[90%] max-h-[80%] object-contain" id="modal-image" onclick="event.stopPropagation();">
        <div id="modal-caption" class="absolute bottom-10 left-0 right-0 mx-auto w-auto max-w-[70%] text-center text-white text-lg p-4 bg-black bg-opacity-70 rounded-md opacity-0 -translate-y-5"></div>
    </div>


    <!-- App Logic -->
    <script>
        const app = {
            // Config & URLs
            config: { /* ... (CSV URLs and COL definitions - unchanged) ... */ 
                CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwnZA7s0yysf5rIflyyj6WNhe_XddN2OCZ6SBJfB06LFm7fANQeZfHTs7GtSlLVXmNoG16BhVStAkD/pub?gid=47128061&single=true&output=csv',
                EVENTOS_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwnZA7s0yysf5rIflyyj6WNhe_XddN2OCZ6SBJfB06LFm7fANQeZfHTs7GtSlLVXmNoG16BhVStAkD/pub?gid=584577480&single=true&output=csv',
                EVENTOSPUNTUALES_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwnZA7s0yysf5rIflyyj6WNhe_XddN2OCZ6SBJfB06LFm7fANQeZfHTs7GtSlLVXmNoG16BhVStAkD/pub?gid=1883625439&single=true&output=csv',
                COLS: { idsitio: 0, autonomia: 1, provincia: 2, ciudad: 3, barrio: 4, nombre: 5, nota: 6, direccion: 7, horario: 8, pintxo_tapa: 9, comida: 10, googleresenas: 11, maps: 12, facebook: 13, instagram: 14, postinstagram: 15, web: 16, lo_ultimo: 17, tipo_lugar: 18, valoracion: 19, codprecio: 20, precio: 21, precioultimo: 22, foto1: 23, text1: 24, foto2: 25, text2: 26, foto3: 27, text3: 28, foto4: 29, text4: 30, foto5: 31, text5: 32, foto6: 33, text6: 34, foto7: 35, text7: 36, foto8: 37, text8: 38, foto9: 39, text9: 40, foto10: 41, text10: 42, foto11: 43, text11: 44, foto12: 45, text12: 46, foto13: 47, text13: 48, foto14: 49, text14: 50, foto15: 51, text15: 52, foto16: 53, text16: 54, foto17: 55, text17: 56, foto18: 57, text18: 58, foto19: 59, text19: 60, foto20: 61, text20: 62, foto21: 63, text21: 64, foto22: 65, text22: 66, foto23: 67, text23: 68, foto24: 69, text24: 70, foto25: 71, text25: 72, foto26: 73, text26: 74, foto27: 75, text27: 76, foto28: 77, text28: 78, foto29: 79, text29: 80, foto30: 81, text30: 82, foto31: 83, text31: 84, foto32: 85, text32: 86, foto33: 87, text33: 88, foto34: 89, text34: 90, foto35: 91, text35: 92, foto36: 93, text36: 94, foto37: 95, text37: 96, foto38: 97, text38: 98, foto39: 99, text39: 100, foto40: 101, text40:102 },
                COLS_EVENTOS: { eventoCulinario: 1, eventoMes: 2, eventoCulinarioDescripcion: 3, idSitio: 4, anyo:5, foto1: 6, text1: 7, foto2: 8, text2: 9, foto3: 10, text3: 11, foto4:12, text4: 13, foto5: 14, text5: 15, foto6: 16, text6: 17, foto7: 18, text7: 19, foto8: 20, text8: 21, foto9: 22, text9: 23, foto10: 24, text10: 25, foto11:26, text11: 27, foto12: 28, text12: 29, foto13: 30, text13: 31, foto14: 32, text14: 33, foto15: 34, text15: 35, foto16: 36, text16: 37, foto17: 38, text17: 39, foto18: 40, text18: 41, foto19:42, text19: 43, foto20: 44, text20:45 },
                COLS_EVENTOSPUNTUALES: { eventoCulinario: 1, eventoMes: 2, eventoCulinarioDescripcion: 3, idSitio: 4, anyo:5, foto1: 6, text1: 7, foto2: 8, text2: 9, foto3: 10, text3: 11, foto4:12, text4: 13, foto5: 14, text5: 15, foto6: 16, text6: 17, foto7: 18, text7: 19, foto8: 20, text8: 21, foto9: 22, text9: 23, foto10: 24, text10: 25, foto11:26, text11: 27, foto12: 28, text12: 29, foto13: 30, text13: 31, foto14: 32, text14: 33, foto15: 34, text15: 35, foto16: 36, text16: 37, foto17: 38, text17: 39, foto18: 40, text18: 41, foto19:42, text19: 43, foto20: 44, text20:45 }
             },
            // App State
            state: { /* ... (unchanged) ... */ 
                isMenuOpen: false, currentPage: 'home', isDataLoaded: false, isLoadingData: false, 
                data: { tapeo: [], eventos: [], eventosPuntuales: [], eventosLookup: {}, eventosPuntualesLookup: {} },
                tapeoState: { level: 'autonomias', selection: {}, history: [], currentSitios: [] },
                galleryState: { slideIndex: 1 }
            },
            // DOM Elements
            elements: {},

            // Init App
            init() {
                console.log("App init starting..."); // Log
                app.elements = { /* ... (cache elements - unchanged) ... */ 
                    header: document.getElementById('app-header'), headerTitle: document.getElementById('header-title'),
                    drawer: document.getElementById('drawer'), drawerScrim: document.getElementById('drawer-scrim'),
                    menuBtn: document.getElementById('menu-btn'), mainNav: document.getElementById('main-nav'), 
                    navLinks: document.querySelectorAll('.nav-link'), pages: document.querySelectorAll('.page-content'),
                    footerYear: document.getElementById('footer-year'),
                    pageTapeo: document.getElementById('page-tapeo'),
                    tapeo: {
                        selector: document.getElementById('tapeo-selector'), detailContainer: document.getElementById('tapeo-detail-container'),
                        backButton: document.getElementById('tapeo-back-button'), breadcrumbs: document.getElementById('tapeo-breadcrumbs'),
                        title: document.getElementById('tapeo-title'), grid: document.getElementById('tapeo-grid'),
                        loading: document.getElementById('tapeo-loading'), error: document.getElementById('tapeo-error'),
                    },
                    modal: {
                        overlay: document.getElementById('photo-modal'), image: document.getElementById('modal-image'),
                        caption: document.getElementById('modal-caption')
                    }
                };
                console.log("Elements cached."); // Log
                if (app.elements.footerYear) app.elements.footerYear.textContent = new Date().getFullYear();

                // Event Listeners
                app.elements.menuBtn.addEventListener('click', app.toggleMenu);
                app.elements.drawerScrim.addEventListener('click', app.toggleMenu);
                document.body.addEventListener('click', (e) => {
                    const navLink = e.target.closest('a.nav-link'); 
                    if (navLink && navLink.dataset.page) { 
                         console.log("Navigating via body listener to:", navLink.dataset.page); 
                         e.preventDefault(); 
                         app.navigateTo(navLink.dataset.page);
                    }
                 });
                app.elements.tapeo.backButton.addEventListener('click', app.tapeo.goBack);
                
                // *** CORRECTION CONFIRMED: Scroll listener IS inside init ***
                window.addEventListener('scroll', app.handleHeaderTransparency);
                console.log("Scroll listener added."); // Log

                app.showPage(app.state.currentPage, true);
                app.updateActiveLink(app.state.currentPage);
                console.log("App init finished."); // Log
            },

            // Navigation & Menu Logic
            toggleMenu() { /* ... (unchanged) ... */ 
                app.state.isMenuOpen = !app.state.isMenuOpen;
                if (app.state.isMenuOpen) {
                    app.elements.drawer.classList.remove('-translate-x-full');
                    app.elements.drawerScrim.classList.remove('hidden');
                    requestAnimationFrame(() => { app.elements.drawerScrim.classList.add('opacity-100'); });
                } else {
                    app.elements.drawer.classList.add('-translate-x-full');
                    app.elements.drawerScrim.classList.remove('opacity-100');
                    setTimeout(() => { if (!app.state.isMenuOpen) app.elements.drawerScrim.classList.add('hidden'); }, 300); 
                }
            },
            navigateTo(pageName) {
                console.log(`MapsTo called with: ${pageName}`);
                if (!pageName || pageName === app.state.currentPage) {
                    if (app.state.isMenuOpen) app.toggleMenu();
                    return;
                }

                if (app.state.isMenuOpen) app.toggleMenu();
                
                // Reset tapeo state ONLY when navigating TO tapeo
                if (pageName === 'tapeo') {
                     console.log("Resetting tapeo state because navigating to tapeo");
                     app.state.tapeoState = {
                         level: 'autonomias', selection: {}, history: [], currentSitios: []
                     };
                     app.tapeo.hideDetail(); 
                }
                
                app.state.currentPage = pageName;
                app.showPage(pageName);
                app.updateActiveLink(pageName); 

                // Load data or render tapeo page
                if (pageName === 'tapeo') {
                    if (!app.state.isDataLoaded && !app.state.isLoadingData) { 
                        app.loadTapeoData();
                    } else if (app.state.isDataLoaded) {
                         console.log("Data loaded, rendering tapeo step"); 
                         app.tapeo.renderStep(); 
                    }
                }
            },
            showPage(pageName, isInitialLoad = false) { /* ... (unchanged) ... */ 
                 if (!pageName) return; 
                app.elements.pages.forEach(page => page.classList.add('hidden'));
                const newPage = document.getElementById(`page-${pageName}`);
                if (newPage) { newPage.classList.remove('hidden'); } 
                else {
                    console.warn(`Page "page-${pageName}" not found. Showing 'home'.`);
                     const homePage = document.getElementById('page-home');
                     if(homePage) homePage.classList.remove('hidden');
                     app.state.currentPage = 'home'; pageName = 'home'; 
                     app.updateActiveLink('home'); 
                }
                 let title = 'ANeKI'; 
                 if (pageName !== 'home') {
                     const link = document.querySelector(`.nav-link[data-page="${pageName}"]`);
                     if (link) {
                         const titleSpan = link.querySelector('span.font-brand');
                         const titleH3 = link.querySelector('h3'); 
                         if (titleSpan) title = titleSpan.textContent;
                         else if (titleH3) title = titleH3.textContent.split(' ')[0];
                         else title = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace(/-/g, ' '); 
                     }
                 }
                 app.elements.headerTitle.textContent = title;
                 app.handleHeaderTransparency(); 
                if (!isInitialLoad) window.scrollTo(0, 0); 
            },
             updateActiveLink(pageName) { /* ... (unchanged) ... */ 
                 if (!app.elements.mainNav) return; 
                 app.elements.mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));
                 const activeLink = app.elements.mainNav.querySelector(`.nav-link[data-page="${pageName}"]`);
                 if (activeLink) activeLink.classList.add('active-link');
             },
             handleHeaderTransparency() { /* ... (unchanged) ... */ 
                if (!app.elements || !app.elements.header) return; // Added check for elements
                const header = app.elements.header;
                 if (app.state.currentPage === 'home' && window.scrollY <= 50) {
                     header.classList.remove('bg-surface', 'shadow-md'); header.classList.add('bg-transparent');
                 } else {
                     header.classList.add('bg-surface', 'shadow-md'); header.classList.remove('bg-transparent');
                 }
             },

            // Data Loading
            async loadTapeoData() { /* ... (unchanged) ... */ 
                if (app.state.isDataLoaded || app.state.isLoadingData) return; 
                app.state.isLoadingData = true; 
                if(app.state.currentPage === 'tapeo') app.tapeo.showLoading(true); 
                try {
                    console.log("Fetching CSV data...");
                    const [tapeoCsvText, eventosCsvText, eventosPuntualesCsvText] = await Promise.all([
                        fetch(app.config.CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(`Error ${res.status}`))),
                        fetch(app.config.EVENTOS_CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(`Error ${res.status}`))),
                        fetch(app.config.EVENTOSPUNTUALES_CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(`Error ${res.status}`)))
                    ]);
                    console.log("CSV data fetched.");
                    app.state.data.tapeo = app.utils.parseCSV(tapeoCsvText).slice(1);
                    app.state.data.eventos = app.utils.parseCSV(eventosCsvText).slice(1);
                    app.state.data.eventosPuntuales = app.utils.parseCSV(eventosPuntualesCsvText).slice(1);
                    console.log("CSV data parsed. Tapeo rows:", app.state.data.tapeo.length);
                    app.state.data.eventosLookup = app.state.data.eventos.reduce((acc, row) => { const id = row[app.config.COLS_EVENTOS.idSitio]; if(id){ if(!acc[id]) acc[id] = []; acc[id].push(row); } return acc; }, {});
                    app.state.data.eventosPuntualesLookup = app.state.data.eventosPuntuales.reduce((acc, row) => { const id = row[app.config.COLS_EVENTOSPUNTUALES.idSitio]; if(id){ if(!acc[id]) acc[id] = []; acc[id].push(row); } return acc; }, {});
                    console.log("Event lookups created.");
                    app.state.isDataLoaded = true;
                    if(app.state.currentPage === 'tapeo') { console.log("Calling renderStep after load."); app.tapeo.renderStep(); }
                } catch (error) {
                    console.error("Error loading data:", error);
                    if(app.state.currentPage === 'tapeo') app.tapeo.displayError(`Data load failed: ${error.message}`);
                } finally {
                     app.state.isLoadingData = false; 
                     if(app.state.currentPage !== 'tapeo' || !app.state.isDataLoaded) app.tapeo.showLoading(false);
                }
            },

            // Tapeo Section Logic
            tapeo: { /* ... (levelsConfig, populateGridWithOptions, populateGridWithSitios, showDetail, hideDetail, handleSelection, goBack, renderBreadcrumbs, showLoading, displayError - all largely unchanged but referencing app.state correctly) ... */ 
                levelsConfig: {
                    autonomias: { title: '¬øD√≥nde quieres ir de pintxos o tapas?', icon: 'public', next: 'provincias', key: app.config.COLS.autonomia },
                    provincias: { title: 'Selecciona una Provincia', icon: 'map', next: 'ciudades', key: app.config.COLS.provincia },
                    ciudades: { title: 'Selecciona una Ciudad', icon: 'location_city', next: 'barrios', key: app.config.COLS.ciudad },
                    barrios: { title: 'Selecciona un Barrio', icon: 'storefront', next: 'sitios', key: app.config.COLS.barrio },
                    sitios: { title: 'Sitios para Tapear', icon: 'tapas', next: null }
                },
                renderStep() {
                     if (!app.state.isDataLoaded) { console.log("renderStep: Data not loaded, calling load."); app.tapeo.showLoading(true); if (!app.state.isLoadingData) app.loadTapeoData(); return; }
                    console.log("Rendering step for level:", app.state.tapeoState.level); 
                    app.tapeo.showLoading(true); 
                    requestAnimationFrame(() => { 
                        try { 
                            let dataToProcess = app.state.data.tapeo; const { selection } = app.state.tapeoState;
                            if (selection.autonomia) dataToProcess = dataToProcess.filter(r => r[app.config.COLS.autonomia] === selection.autonomia);
                            if (selection.provincia) dataToProcess = dataToProcess.filter(r => r[app.config.COLS.provincia] === selection.provincia);
                            if (selection.ciudad) dataToProcess = dataToProcess.filter(r => r[app.config.COLS.ciudad] === selection.ciudad);
                            if (selection.barrio && selection.barrio !== 'Todos') dataToProcess = dataToProcess.filter(r => r[app.config.COLS.barrio] === selection.barrio);
                            app.elements.tapeo.backButton.classList.toggle('hidden', app.state.tapeoState.history.length === 0);
                            app.elements.tapeo.backButton.classList.toggle('inline-flex', app.state.tapeoState.history.length > 0);
                            app.tapeo.renderBreadcrumbs();
                            let uniqueValues = []; 
                            if (app.state.tapeoState.level === 'sitios') { app.tapeo.populateGridWithSitios(dataToProcess); } 
                            else {
                                const cfg = app.tapeo.levelsConfig[app.state.tapeoState.level]; if (!cfg) throw new Error(`Invalid level: ${app.state.tapeoState.level}`);
                                const key = cfg.key; uniqueValues = [...new Set(dataToProcess.map(r => r[key]))].filter(Boolean).sort();
                                if (app.state.tapeoState.level === 'barrios' && uniqueValues.length > 1) uniqueValues.unshift('Todos');
                                if (uniqueValues.length === 1 && app.state.tapeoState.level !== 'sitios') {
                                    if (!uniqueValues[0]) { console.log("Single empty value."); app.tapeo.populateGridWithOptions([]); app.tapeo.showLoading(false); return; }
                                     console.log("Auto-skipping:", app.state.tapeoState.level); app.state.tapeoState.history.push({ level: app.state.tapeoState.level, selection: { ...app.state.tapeoState.selection }, skipped: true });
                                    setTimeout(() => app.tapeo.handleSelection(uniqueValues[0], true), 0); return; 
                                }
                                app.tapeo.populateGridWithOptions(uniqueValues);
                            }
                            const shouldHide = !(uniqueValues && uniqueValues.length === 1 && app.state.tapeoState.level !== 'sitios');
                            if (shouldHide) setTimeout(() => app.tapeo.showLoading(false), 50); 
                        } catch(error) { console.error("Error in renderStep rAF:", error); app.tapeo.displayError(`Render error: ${error.message}`); app.tapeo.showLoading(false); }
                    }); 
                },
                populateGridWithOptions(data) { /* ... (unchanged) ... */ 
                    const config = app.tapeo.levelsConfig[app.state.tapeoState.level]; if (!config) { console.error("Config missing:", app.state.tapeoState.level); return; }
                    app.elements.tapeo.title.textContent = config.title; const grid = app.elements.tapeo.grid; grid.innerHTML = ''; 
                    grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6'; 
                    if (data.length === 0) { grid.innerHTML = `<p class="font-brand text-xl text-center sm:col-span-2 md:col-span-3">No hay opciones disponibles.</p>`; return; }
                    data.forEach(item => { const safeItem = item.replace(/'/g, "\\'"); const cardHtml = `<div class="bg-surface rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition-all duration-300 cursor-pointer group" onclick="app.tapeo.handleSelection('${safeItem}')"><div class="p-6 flex flex-col items-center text-center h-full"><div class="bg-primary-container text-on-primary-container rounded-full p-4 mb-4 inline-flex group-hover:bg-primary group-hover:text-on-primary transition-colors duration-200"><span class="material-icons text-4xl">${config.icon}</span></div><h3 class="text-2xl group-hover:text-secondary transition-colors duration-200">${item}</h3></div></div>`; grid.insertAdjacentHTML('beforeend', cardHtml); });
                },
                populateGridWithSitios(data) { /* ... (unchanged) ... */ 
                    app.elements.tapeo.title.textContent = app.tapeo.levelsConfig.sitios.title; const grid = app.elements.tapeo.grid; grid.innerHTML = ''; grid.className = 'grid grid-cols-1 gap-6'; 
                    const sortedData = data.sort((a, b) => (parseFloat(b[app.config.COLS.nota]) || 0) - (parseFloat(a[app.config.COLS.nota]) || 0)); app.state.tapeoState.currentSitios = sortedData;
                    if (sortedData.length === 0) { grid.innerHTML = `<p class="font-brand text-xl text-center">No se encontraron sitios para esta selecci√≥n.</p>`; return; }
                    sortedData.forEach((row, index) => { const C = app.config.COLS; const img = row[C.foto1] ? `https://drive.google.com/thumbnail?id=${row[C.foto1]}&sz=w600` : ''; let price = ''; if (row[C.codprecio] == 10) price = 'Precio muy bien ‚úÖ'; else if (row[C.codprecio] == 11) price = 'Precio justo ‚öñÔ∏è'; else if (row[C.codprecio] == 12) price = 'Precio caro üíÄ'; const card = `<div class="bg-surface rounded-2xl shadow-md overflow-hidden flex flex-col md:flex-row">${img ? `<div class="md:w-1/3 h-64 md:h-auto flex-shrink-0 bg-cover bg-center" style="background-image: url('${img}');"></div>` : '<div class="md:w-1/3 h-64 md:h-auto flex-shrink-0 bg-gray-200 flex items-center justify-center"><span class="material-icons text-6xl text-gray-400">hide_image</span></div>'}<div class="p-6 flex flex-col flex-grow text-center"><h3 class="text-3xl mb-2">${row[C.nombre]||'N/A'}</h3><div class="text-2xl mb-4" style="color: #ff4081;">${row[C.valoracion]||''}</div>${row[C.nota]?`<p class="font-brand text-on-surface opacity-80 text-lg mb-4 text-left whitespace-pre-wrap">${row[C.nota]}</p>`:''}<hr class="border-t-2 border-primary/50 my-2"><p class="font-brand text-on-surface text-lg my-2">${price}</p><hr class="border-t-2 border-primary/50 my-2">${row[C.pintxo_tapa]?`<p class="font-brand text-on-surface opacity-80 text-lg mb-4 text-left whitespace-pre-wrap flex-grow">${row[C.pintxo_tapa]}</p>`:'<div class="flex-grow"></div>'}<button class="mt-4 bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors inline-flex items-center justify-center self-center" onclick="app.tapeo.showDetail(${index})"><span class="material-icons mr-2">visibility</span>Ver info</button></div></div>`; grid.insertAdjacentHTML('beforeend', card); });
                },
                showDetail(index) { /* ... (unchanged, includes gallery building) ... */ 
                     console.log("Showing detail:", index); const siteRow = app.state.tapeoState.currentSitios[index]; if (!siteRow) { console.error("Site not found:", index); return; }
                    const C=app.config.COLS, CE=app.config.COLS_EVENTOS, CEP=app.config.COLS_EVENTOSPUNTUALES; const site = Object.keys(C).reduce((o,k)=>{o[k]=siteRow[C[k]]; return o;}, {});
                    app.elements.tapeo.selector.classList.add('hidden'); const galleryData=[]; for(let i=1;i<=40;i++) if(site[`foto${i}`]) galleryData.push({url:`https://drive.google.com/thumbnail?id=${site[`foto${i}`]}&sz=w600`, text:site[`text${i}`]||`Foto ${site.nombre}`}); let galleryHtml=''; if(galleryData.length>0){ const slides=galleryData.map((item,i)=>`<div class="mySlides"><div class="numbertext">${i+1}/${galleryData.length}</div><img src="${item.url}" class="w-full rounded-lg shadow" alt="${item.text}"></div>`).join(''); const numThumbs=galleryData.length; const colW=numThumbs>=6?'w-1/6':numThumbs===5?'w-1/5':numThumbs===4?'w-1/4':numThumbs===3?'w-1/3':numThumbs===2?'w-1/2':'w-full'; const thumbs=galleryData.map((item,i)=>`<div class="column ${colW} p-1"><img class="demo cursor rounded block w-full h-auto aspect-[4/3] object-cover" src="${item.url.replace('&sz=w600','&sz=w200')}" onclick="app.gallery.currentSlide(${i+1})" alt="${item.text}"></div>`).join(''); galleryHtml=`<div class="gallery-container mb-6">${slides}<a class="prev" onclick="app.gallery.plusSlides(-1)">‚ùÆ</a><a class="next" onclick="app.gallery.plusSlides(1)">‚ùØ</a><div class="caption-container rounded-b-lg"><p id="caption"></p></div><div class="row mt-2 flex flex-wrap justify-center">${thumbs}</div></div>`;}
                    const buildEvent=(lookup,cols,title)=>{ let html=''; const events=lookup[site.idsitio]||[]; if(events.length>0){ const cards=events.map(row=>{ const gallery=[]; for(let i=1;i<=20;i++) if(row[cols[`foto${i}`]]) gallery.push({url:`https://drive.google.com/thumbnail?id=${row[cols[`foto${i}`]]}&sz=w400`, text:row[cols[`text${i}`]]||''}); const images=gallery.map(item=>{ const parts=item.text.split('\n'); const l1=parts[0]||''; const l2=parts[1]||''; const safe=(l2||l1).replace(/'/g,"\\'"); const imgUrl=item.url.includes('thumbnail?id=')?item.url:'https://placehold.co/400x400/E0F2F1/004D40?text=Error'; return `<div class="aspect-square bg-cover bg-center rounded-lg relative overflow-hidden cursor-pointer group shadow hover:shadow-lg transition-shadow" style="background-image: url('${imgUrl}');" onclick="app.gallery.openModal('${imgUrl.replace('&sz=w400','&sz=w1600')}', '${safe}')"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-all duration-300 flex items-end"><div class="text-white p-2 text-xs font-brand opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 w-full bg-black/50 text-center">${l1}${l2?`<br>${l2}`:''}</div></div></div>`;}).join(''); return `<div class="bg-white/70 rounded-lg shadow-md overflow-hidden flex flex-col"><div class="p-4 text-center border-b border-gray-300"><h4 class="text-xl">${row[cols.eventoCulinario]||''} ${row[cols.anyo]||''}</h4><p class="font-brand text-sm italic opacity-70 mt-1">${row[cols.eventoCulinarioDescripcion]||''}</p></div>${images?`<div class="p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">${images}</div>`:''}</div>`;}).join(''); html=`<div class="mt-8 pt-6 border-t border-primary/30"><h3 class="text-3xl text-center mb-6">${title}</h3><div class="grid grid-cols-1 ${events.length>1?'lg:grid-cols-2':''} gap-6">${cards}</div></div>`;} return html;};
                    const eventosHtml=buildEvent(app.state.data.eventosLookup,CE,"Eventos Habituales"); const eventosPuntualesHtml=buildEvent(app.state.data.eventosPuntualesLookup,CEP,"Eventos Puntuales");
                    const actions=[ site.postinstagram?`<a href="${site.postinstagram}" target="_blank" rel="noopener" class="flex items-center justify-center bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors"><span class="material-icons mr-2">photo_camera</span>√öltima Visita</a>`:'', site.googleresenas?`<a href="${site.googleresenas}" target="_blank" rel="noopener" class="flex items-center justify-center bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors"><span class="material-icons mr-2">rate_review</span>Rese√±as</a>`:'', site.maps?`<a href="${site.maps}" target="_blank" rel="noopener" class="flex items-center justify-center bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors"><span class="material-icons mr-2">place</span>Mapa</a>`:'', site.instagram?`<a href="${site.instagram}" target="_blank" rel="noopener" class="flex items-center justify-center bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors"><span class="material-icons mr-2">camera_alt</span>Instagram</a>`:'', site.web?`<a href="${site.web}" target="_blank" rel="noopener" class="flex items-center justify-center bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors"><span class="material-icons mr-2">language</span>Web</a>`:'' ].filter(Boolean).join('');
                    let price=''; if(site.codprecio==10) price='Precio muy bien ‚úÖ'; else if(site.codprecio==11) price='Precio justo ‚öñÔ∏è'; else if(site.codprecio==12) price='Precio caro üíÄ'; let tipo=''; if(site.tipo_lugar=='Bar y Restaurante') tipo=`Ademas de tapear puedes comer y en nuestra secci√≥n de restaurantes te lo contamos.`;
                    const detail=`<button class="mb-6 bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors inline-flex items-center" onclick="app.tapeo.hideDetail()"><span class="material-icons mr-2">arrow_back</span>VOLVER</button><div class="bg-surface rounded-2xl shadow-lg p-4 md:p-8"><div class="text-center mb-6"><h2 class="text-4xl md:text-5xl mb-2">${site.nombre||''}</h2><div class="text-3xl mb-4" style="color:#ff4081;">${site.valoracion||''}</div><div class="font-brand text-lg text-on-surface opacity-90 space-y-2">${site.nota?`<p class="whitespace-pre-wrap">${site.nota}</p>`:''}<hr class="border-t-2 border-primary/30 max-w-xs mx-auto my-3"><p>${price}</p>${tipo?`<hr class="border-t-2 border-primary/30 max-w-xs mx-auto my-3"><p>${tipo}</p>`:''}</div></div><div class="flex flex-wrap gap-3 justify-center my-6">${actions}</div>${galleryHtml}<div class="mt-8 text-center"><p class="font-brand text-lg text-on-surface opacity-90 whitespace-pre-wrap mb-6">${site.pintxo_tapa||''}</p>${site.direccion?`<p class="font-brand text-lg mt-6 flex items-center justify-center text-left"><span class="material-icons align-middle -mt-1 mr-2 flex-shrink-0">place</span><span><b>Direcci√≥n:</b> ${site.direccion}</span></p>`:''}${site.horario?`<p class="font-brand text-lg mt-4 whitespace-pre-wrap text-left"><span class="material-icons align-top -mt-0 mr-2">schedule</span><b>Horario:</b><br><span class="ml-8">${site.horario.replace(/\n/g,'<br class="ml-8">')}</span></p>`:''}${eventosHtml}${eventosPuntualesHtml}</div></div><button class="mt-8 bg-primary text-on-primary font-brand px-4 py-2 rounded-lg shadow-md hover:bg-secondary transition-colors inline-flex items-center" onclick="app.tapeo.hideDetail()"><span class="material-icons mr-2">arrow_back</span>VOLVER</button>`;
                    app.elements.tapeo.detailContainer.innerHTML=detail; app.elements.tapeo.detailContainer.classList.remove('hidden'); if(galleryData.length>0){ app.state.galleryState.slideIndex=1; requestAnimationFrame(()=>app.gallery.showSlides(1)); } window.scrollTo(0,0); 
                },
                hideDetail() { /* ... (unchanged) ... */ 
                    app.elements.tapeo.detailContainer.innerHTML = ''; app.elements.tapeo.detailContainer.classList.add('hidden');
                    app.elements.tapeo.selector.classList.remove('hidden'); window.scrollTo(0, 0); 
                },
                handleSelection(selectionName, isAutoSelection = false) { /* ... (unchanged) ... */ 
                     console.log(`Selection: ${selectionName}, auto: ${isAutoSelection}`); const state = app.state.tapeoState;
                    if (!isAutoSelection) state.history.push({ level: state.level, selection: { ...state.selection }, skipped: false });
                    let key = state.level.slice(0, -1); if (state.level === 'ciudades') key = 'ciudad'; state.selection[key] = selectionName;
                     const nextLevel = app.tapeo.levelsConfig[state.level]?.next; 
                    if (nextLevel) { state.level = nextLevel; app.tapeo.renderStep(); } 
                    else if (app.tapeo.levelsConfig[state.level] && !nextLevel) { state.level = 'sitios'; app.tapeo.renderStep(); } 
                    else { console.error("Invalid next level:", state.level); app.tapeo.displayError("Internal error."); }
                     window.scrollTo(0, 0); 
                },
                goBack() { /* ... (unchanged) ... */ 
                    const state = app.state.tapeoState; let lastState = state.history.pop();
                    while (lastState && lastState.skipped) lastState = state.history.pop();
                    if (lastState) { state.level = lastState.level; state.selection = lastState.selection; } 
                    else { state.level = 'autonomias'; state.selection = {}; state.history = []; }
                    app.tapeo.hideDetail(); app.tapeo.renderStep(); window.scrollTo(0, 0); 
                },
                renderBreadcrumbs() { /* ... (unchanged) ... */ 
                    const { selection } = app.state.tapeoState; const crumbs = [];
                    if (selection.autonomia) crumbs.push(selection.autonomia); if (selection.provincia) crumbs.push(selection.provincia);
                    if (selection.ciudad) crumbs.push(selection.ciudad); if (selection.barrio && selection.barrio !== 'Todos') crumbs.push(selection.barrio);
                    app.elements.tapeo.breadcrumbs.innerHTML = crumbs.join(' <span class="font-bold mx-1"> &gt; </span> ');
                },
                showLoading(isLoading) { /* ... (unchanged) ... */ 
                     if (app.state.currentPage === 'tapeo') {
                        app.elements.tapeo.loading.classList.toggle('hidden', !isLoading); app.elements.tapeo.loading.classList.toggle('flex', isLoading);
                        app.elements.tapeo.grid.classList.toggle('hidden', isLoading); app.elements.tapeo.grid.classList.toggle('grid', !isLoading); 
                        if(isLoading) app.elements.tapeo.error.classList.add('hidden'); 
                     } else {
                          app.elements.tapeo.loading.classList.add('hidden'); app.elements.tapeo.loading.classList.remove('flex');
                     }
                },
                displayError(message) { /* ... (unchanged) ... */ 
                    app.elements.tapeo.loading.classList.add('hidden'); app.elements.tapeo.grid.classList.add('hidden'); 
                    const errorEl = app.elements.tapeo.error; errorEl.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold font-brand">Error</strong><span class="block sm:inline font-brand">${message}</span></div>`;
                    errorEl.classList.remove('hidden');
                }
            },

            // Gallery/Modal Logic
            gallery: { /* ... (plusSlides, currentSlide, showSlides, openModal, closeModal - all unchanged) ... */ 
                plusSlides(n) { const newIdx = app.state.galleryState.slideIndex += n; app.gallery.showSlides(newIdx); },
                currentSlide(n) { app.state.galleryState.slideIndex = n; app.gallery.showSlides(n); },
                showSlides(n) {
                    const cont = app.elements.tapeo.detailContainer; if(!cont || cont.classList.contains('hidden')) return; // Added null check
                    const slides = cont.getElementsByClassName("mySlides"), dots = cont.getElementsByClassName("demo"), cap = cont.querySelector("#caption"); 
                    if (!cap || slides.length === 0) return; let idx = n; if (n > slides.length) idx = 1; if (n < 1) idx = slides.length; app.state.galleryState.slideIndex = idx; 
                    for (let i=0;i<slides.length;i++) slides[i].style.display="none"; for (let i=0;i<dots.length;i++) dots[i].classList.remove("active"); 
                    if (slides[idx-1]) slides[idx-1].style.display="block"; if(dots[idx-1]){ dots[idx-1].classList.add("active"); cap.innerHTML=dots[idx-1].alt; } else { cap.innerHTML=""; }
                },
                openModal(imgUrl, imgTxt) {
                    const { overlay, image, caption } = app.elements.modal; try { new URL(imgUrl); image.src = imgUrl; } catch (_) { console.error("Invalid image URL:", imgUrl); image.src = 'https://placehold.co/800x600/E0F2F1/004D40?text=Error'; }
                    caption.innerHTML = imgTxt || ''; overlay.classList.remove('hidden'); overlay.classList.add('flex'); setTimeout(() => { overlay.classList.add('opacity-100'); caption.classList.remove('opacity-0', '-translate-y-5'); }, 10); 
                },
                closeModal() {
                    const { overlay, image, caption } = app.elements.modal; overlay.classList.remove('opacity-100'); caption.classList.add('opacity-0', '-translate-y-5');
                    setTimeout(() => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); image.src = ''; caption.innerHTML = ''; }, 300); 
                }
            },

            // Utilities
            utils: { /* ... (parseCSV - unchanged) ... */ 
                parseCSV(csvTxt) { const rows=[], fields=[]; let field='', inQ=false; csvTxt=csvTxt.trim().replace(/\r\n/g,'\n').replace(/\r/g,'\n'); for(let i=0;i<csvTxt.length;i++){ const char=csvTxt[i], next=csvTxt[i+1]; if(char==='"'){ if(inQ&&next==='"'){ field+='"'; i++; } else { inQ=!inQ; }} else if(char===','&&!inQ){ fields.push(field); field=''; } else if(char==='\n'&&!inQ){ fields.push(field); if(fields.some(f=>f.trim()!=='')) rows.push(fields.map(f=>f.trim())); fields.length=0; field=''; } else { field+=char; }} if(fields.length>0||field.trim()!==''){ fields.push(field); if(fields.some(f=>f.trim()!=='')) rows.push(fields.map(f=>f.trim())); } return rows; }
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', app.init);
        
    </script>
</body>
</html>

